<div id="smartReportModal" class="modal">
    <div class="glass p-6 w-full max-w-md max-h-[90vh] overflow-y-auto space-y-6">
        <div class="flex justify-between items-center border-b border-white/10 pb-4">
            <h2 class="text-xl font-bold text-blue-400"><i class="fas fa-chart-line mr-2"></i>Smart Insights</h2>
            <button onclick="toggleReport()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>

        <div>
            <label class="text-blue-400 mb-2">Most Profitable Companies</label>
            <div id="companyStats" class="space-y-2"></div>
        </div>

        <hr class="border-white/5">

        <div>
            <label class="text-yellow-500 mb-2">Solo vs Partner (Profit Per Day)</label>
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                    <div class="text-[10px] uppercase text-gray-400">Solo Effort</div>
                    <div id="soloEffort" class="text-lg font-bold text-green-400">₹0/day</div>
                </div>
                <div class="bg-white/5 p-3 rounded-xl border border-white/10">
                    <div class="text-[10px] uppercase text-gray-400">Partner Effort</div>
                    <div id="partnerEffort" class="text-lg font-bold text-blue-400">₹0/day</div>
                </div>
            </div>
            <p id="effortVerdict" class="text-[11px] italic mt-2 text-gray-400"></p>
        </div>

        <button onclick="toggleReport()" class="w-full bg-slate-800 py-3 rounded-xl font-bold uppercase text-xs">Close Report</button>
    </div>
</div>

<div class="summary-footer max-w-md mx-auto rounded-t-3xl">
    <div class="grid grid-cols-4 gap-2 px-2 mb-2">
        <button onclick="toggleReport()" class="col-span-4 bg-gradient-to-r from-blue-600 to-indigo-600 py-2 rounded-xl text-xs font-black uppercase shadow-lg mb-1">
            <i class="fas fa-bolt mr-2"></i>View Smart Report
        </button>
    </div>
    </div>

<script>
    function toggleReport() {
        const m = document.getElementById('smartReportModal');
        const isOpen = m.style.display === 'flex';
        m.style.display = isOpen ? 'none' : 'flex';
        if (!isOpen) generateSmartReport();
    }

    function generateSmartReport() {
        const stats = {};
        let soloTotal = 0, soloDays = 0;
        let partTotal = 0, partDays = 0;

        allEntries.forEach(d => {
            if (d.isHoliday) return;

            // Calculate Site Expenses for this specific job
            let siteExp = 0;
            d.logs?.forEach(l => { 
                siteExp += (parseFloat(l.sal)||0) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
            });
            
            const netProfit = (parseFloat(d.total) || 0) - siteExp;
            const myShare = d.projectType === 'Partner' ? netProfit / 2 : netProfit;
            const daysCount = d.logs?.length || 1;

            // Company Wise Logic
            if (!stats[d.company]) stats[d.company] = { jobs: 0, profit: 0 };
            stats[d.company].jobs += 1;
            stats[d.company].profit += myShare;

            // Effort Logic
            if (d.projectType === 'Solo') {
                soloTotal += myShare;
                soloDays += daysCount;
            } else {
                partTotal += myShare;
                partDays += daysCount;
            }
        });

        // Render Company Stats
        const compDiv = document.getElementById('companyStats');
        compDiv.innerHTML = Object.entries(stats)
            .sort((a, b) => b[1].profit - a[1].profit)
            .map(([name, data]) => `
                <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg border border-white/5">
                    <div>
                        <div class="text-sm font-bold">${name}</div>
                        <div class="text-[10px] text-gray-500">${data.jobs} Projects</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm font-black text-green-400">₹${Math.round(data.profit).toLocaleString()}</div>
                        <div class="text-[9px] text-gray-500 uppercase">Total Profit</div>
                    </div>
                </div>
            `).join('') || '<div class="text-gray-500 text-sm">No data available</div>';

        // Render Effort Stats
        const sPerDay = soloDays ? Math.round(soloTotal / soloDays) : 0;
        const pPerDay = partDays ? Math.round(partTotal / partDays) : 0;
        
        document.getElementById('soloEffort').innerText = `₹${sPerDay.toLocaleString()}/day`;
        document.getElementById('partnerEffort').innerText = `₹${pPerDay.toLocaleString()}/day`;

        const verdict = sPerDay > pPerDay 
            ? "Solo work is making you more money per day of effort." 
            : "Partnership is more efficient for your time.";
        document.getElementById('effortVerdict').innerText = `Analysis: ${verdict}`;
    }
</script>
