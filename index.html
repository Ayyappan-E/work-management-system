<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayyappan Work Manager | Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #f1f5f9; min-height: 100vh; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .field-group { display: flex; flex-direction: column; gap: 4px; }
        label { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.05em; margin-left: 4px; }
        .input-box { background: rgba(0,0,0,0.3); border: 1px solid #334155; border-radius: 0.6rem; padding: 0.8rem; color: white; width: 100%; outline: none; }
        .input-box:focus { border-color: #3b82f6; background: rgba(0,0,0,0.5); }
        .mobile-view { max-width: 500px; margin: 0 auto; width: 100%; }
        .btn-update { background: linear-gradient(90deg, #10b981, #059669); }
    </style>
</head>
<body class="p-4 pb-24">

    <div class="mobile-view">
        <div class="flex items-center gap-3 mb-6 animate-pulse">
            <div class="bg-blue-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg"><i class="fas fa-tools"></i></div>
            <h1 class="text-xl font-black tracking-tight">AYYAPPAN <span class="text-blue-500 text-sm">WORKS</span></h1>
        </div>

        <div class="glass p-5 mb-8 shadow-2xl">
            <h2 id="formTitle" class="text-xs font-bold text-blue-400 mb-6 flex items-center gap-2">
                <i class="fas fa-plus-circle"></i> ADD NEW WORK ENTRY
            </h2>
            <input type="hidden" id="editId">
            
            <div class="space-y-5">
                <div class="grid grid-cols-2 gap-4">
                    <div class="field-group">
                        <label>Entry Date</label>
                        <input type="date" id="date" class="input-box">
                    </div>
                    <div class="field-group">
                        <label>Quotation No (Qn)</label>
                        <input type="text" id="qn" placeholder="Enter Qn" class="input-box">
                    </div>
                </div>

                <div class="flex items-center gap-3 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                    <input type="checkbox" id="isHoliday" onchange="checkHoliday()" class="w-5 h-5 accent-red-500">
                    <label class="text-red-300 m-0">Mark as Holiday (Disables Fields)</label>
                </div>

                <div id="workFields" class="space-y-5">
                    <div class="field-group">
                        <label>Working Company Name</label>
                        <input type="text" id="company" placeholder="e.g. Sharp Glass" class="input-box">
                    </div>
                    <div class="field-group">
                        <label>Customer Name</label>
                        <input type="text" id="customer" placeholder="Enter name" class="input-box">
                    </div>
                    <div class="field-group">
                        <label>Location</label>
                        <input type="text" id="location" placeholder="Site location" class="input-box">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="field-group">
                            <label>Window Quantity</label>
                            <input type="number" id="winQty" placeholder="0" class="input-box">
                        </div>
                        <div class="field-group">
                            <label>Amt Per Sqft (₹)</label>
                            <input type="number" id="amtRate" oninput="calculateTotal()" placeholder="0.00" class="input-box">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="field-group">
                            <label>Total Square Feet</label>
                            <input type="number" id="totalSqft" oninput="calculateTotal()" placeholder="Enter Total Sqft" class="input-box bg-slate-800/50 border-blue-500/30">
                        </div>
                        <div class="field-group">
                            <label>Total Amount (₹)</label>
                            <input type="text" id="resTotal" readonly class="input-box bg-blue-900/20 text-green-400 font-bold" value="0">
                        </div>
                    </div>
                    
                    <div class="bg-black/20 p-4 rounded-xl space-y-3">
                        <label class="text-blue-400">Helper & Petrol Details</label>
                        <div id="helperList" class="space-y-3">
                            <div class="grid grid-cols-3 gap-2 helper-row">
                                <input type="text" placeholder="Name" class="input-box text-xs h-name">
                                <input type="number" placeholder="Salary" class="input-box text-xs h-sal">
                                <input type="number" placeholder="Petrol" class="input-box text-xs h-pet">
                            </div>
                        </div>
                        <button onclick="addHelperRow()" class="text-[10px] bg-slate-700 px-3 py-1 rounded-full">+ Add More Helper</button>
                    </div>

                    <div class="field-group">
                        <label>Payment Status</label>
                        <select id="payStatus" class="input-box">
                            <option value="Pending">Pending</option>
                            <option value="Partial">Partial</option>
                            <option value="Received">Received</option>
                        </select>
                    </div>
                </div>

                <div class="field-group">
                    <label>Reason / Comments</label>
                    <textarea id="comment" placeholder="Write reason if holiday or site notes..." class="input-box h-20"></textarea>
                </div>

                <button onclick="saveData()" id="mainBtn" class="w-full bg-blue-600 hover:bg-blue-500 py-4 rounded-xl font-black tracking-widest shadow-lg shadow-blue-500/20">SAVE ENTRY</button>
                <button onclick="location.reload()" id="cancelBtn" class="w-full bg-slate-700 py-2 rounded-xl text-xs hidden">CANCEL EDIT</button>
            </div>
        </div>

        <div class="glass p-6 text-center mb-8 border-b-4 border-green-500">
            <p class="text-[10px] uppercase text-gray-400 tracking-tighter">Monthly Summary (Feb 2026)</p>
            <h2 id="monthDisplay" class="text-3xl font-black text-white">₹0</h2>
            <p id="motivation" class="text-xs text-blue-300 mt-2 font-medium italic">"Every square foot built is a step toward success!"</p>
        </div>

        <div class="flex justify-between items-center px-2 mb-4">
            <h3 class="text-sm font-black">WORK HISTORY</h3>
            <i class="fas fa-filter text-gray-500 text-xs"></i>
        </div>
        <div id="displayArea" class="space-y-4">
            </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58",
            authDomain: "ayyappan-work-management.firebaseapp.com",
            projectId: "ayyappan-work-management"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 1. Calculation: Sqft * Rate
        function calculateTotal() {
            const sqft = parseFloat(document.getElementById('totalSqft').value) || 0;
            const rate = parseFloat(document.getElementById('amtRate').value) || 0;
            const final = sqft * rate;
            document.getElementById('resTotal').value = final.toFixed(2);
        }

        function checkHoliday() {
            const h = document.getElementById('isHoliday').checked;
            document.getElementById('workFields').style.opacity = h ? '0.2' : '1';
            document.getElementById('workFields').style.pointerEvents = h ? 'none' : 'auto';
        }

        function addHelperRow() {
            const div = document.createElement('div');
            div.className = "grid grid-cols-3 gap-2 helper-row animate-entry";
            div.innerHTML = `
                <input type="text" placeholder="Name" class="input-box text-xs h-name">
                <input type="number" placeholder="Salary" class="input-box text-xs h-sal">
                <input type="number" placeholder="Petrol" class="input-box text-xs h-pet">
            `;
            document.getElementById('helperList').appendChild(div);
        }

        // 2. Save & Update
        async function saveData() {
            const id = document.getElementById('editId').value;
            const helpers = [];
            document.querySelectorAll('.helper-row').forEach(row => {
                const n = row.querySelector('.h-name').value;
                if(n) helpers.push({ name: n, sal: row.querySelector('.h-sal').value, pet: row.querySelector('.h-pet').value });
            });

            const data = {
                date: document.getElementById('date').value,
                qn: document.getElementById('qn').value,
                isHoliday: document.getElementById('isHoliday').checked,
                company: document.getElementById('company').value,
                customer: document.getElementById('customer').value,
                location: document.getElementById('location').value,
                winQty: document.getElementById('winQty').value,
                totalSqft: document.getElementById('totalSqft').value,
                amtRate: document.getElementById('amtRate').value,
                total: document.getElementById('resTotal').value,
                status: document.getElementById('payStatus').value,
                helpers: helpers,
                comment: document.getElementById('comment').value,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                if(id) {
                    await db.collection("workLogs").doc(id).update(data);
                } else {
                    await db.collection("workLogs").add(data);
                }
                alert("Success!");
                location.reload();
            } catch(e) { alert("Error: " + e.message); }
        }

        // 3. Data Fetching
        db.collection("workLogs").orderBy("date", "desc").onSnapshot(snap => {
            const container = document.getElementById('displayArea');
            let monthlyGrandTotal = 0;
            container.innerHTML = "";
            
            snap.forEach(doc => {
                const d = doc.data();
                monthlyGrandTotal += parseFloat(d.total || 0);

                const div = document.createElement('div');
                div.className = "glass p-4 border-l-4 " + (d.isHoliday ? 'border-red-500' : 'border-blue-500');
                div.innerHTML = `
                    <div class="flex justify-between items-center" onclick="toggleDetails('${doc.id}')">
                        <div>
                            <p class="text-[10px] text-gray-500 font-bold uppercase">${d.date} | Qn: ${d.qn || 'NA'}</p>
                            <h4 class="font-bold text-sm">${d.isHoliday ? 'HOLIDAY' : (d.customer || 'Unnamed Site')}</h4>
                            <p class="text-[10px] text-blue-400">${d.location || 'No Location'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-black text-green-400">₹${d.total}</p>
                            <span class="text-[9px] bg-slate-800 px-2 py-1 rounded text-gray-400">${d.status}</span>
                            <i class="fas fa-plus ml-2 text-xs text-slate-600"></i>
                        </div>
                    </div>
                    <div id="details-${doc.id}" class="hidden mt-4 pt-4 border-t border-white/5 space-y-3">
                        <div class="grid grid-cols-2 text-[11px] gap-2">
                            <p><b>Company:</b> ${d.company}</p>
                            <p><b>Total Sqft:</b> ${d.totalSqft}</p>
                        </div>
                        <div class="text-[11px]">
                            <p class="font-bold text-blue-400 mb-1">Helpers:</p>
                            ${d.helpers && d.helpers.length ? d.helpers.map(h => `<div class="flex justify-between border-b border-white/5 pb-1"><span>${h.name}</span> <span>Sal: ${h.sal} | Pet: ${h.pet}</span></div>`).join('') : 'No helpers'}
                        </div>
                        <p class="text-[11px] italic text-gray-500">"${d.comment}"</p>
                        <div class="flex gap-4 pt-2">
                            <button onclick="editDoc('${doc.id}')" class="text-blue-400 text-xs font-bold"><i class="fas fa-edit"></i> UPDATE</button>
                            <button onclick="deleteDoc('${doc.id}')" class="text-red-400 text-xs font-bold"><i class="fas fa-trash"></i> DELETE</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            document.getElementById('monthDisplay').innerText = "₹" + monthlyGrandTotal.toLocaleString();
        });

        function toggleDetails(id) {
            document.getElementById('details-'+id).classList.toggle('hidden');
        }

        async function deleteDoc(id) {
            if(confirm("Permanently delete this?")) await db.collection("workLogs").doc(id).delete();
        }

        async function editDoc(id) {
            const doc = await db.collection("workLogs").doc(id).get();
            const d = doc.data();
            document.getElementById('editId').value = id;
            document.getElementById('date').value = d.date;
            document.getElementById('qn').value = d.qn;
            document.getElementById('isHoliday').checked = d.isHoliday;
            document.getElementById('company').value = d.company;
            document.getElementById('customer').value = d.customer;
            document.getElementById('location').value = d.location;
            document.getElementById('winQty').value = d.winQty;
            document.getElementById('totalSqft').value = d.totalSqft;
            document.getElementById('amtRate').value = d.amtRate;
            document.getElementById('resTotal').value = d.total;
            document.getElementById('payStatus').value = d.status;
            document.getElementById('comment').value = d.comment;

            document.getElementById('formTitle').innerText = "EDITING RECORD";
            document.getElementById('mainBtn').innerText = "CONFIRM UPDATE";
            document.getElementById('mainBtn').classList.add('btn-update');
            document.getElementById('cancelBtn').classList.remove('hidden');
            window.scrollTo({top: 0, behavior: 'smooth'});
            checkHoliday();
        }

        window.onload = () => { document.getElementById('date').valueAsDate = new Date(); };
    </script>
</body>
</html>
