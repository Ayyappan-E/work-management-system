<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Job Report</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{--bg:#fff;--text:#000}
.dark{--bg:#1e1e1e;--text:#fff}
body{
  margin:0;font-family:Arial;color:var(--text);
  background:linear-gradient(135deg,#667eea,#764ba2,#6ee7b7);
  background-size:400% 400%;animation:bg 10s infinite;
}
@keyframes bg{0%{background-position:0%}50%{background-position:100%}100%{background-position:0%}}
.container{
  max-width:1100px;margin:20px auto;
  background:var(--bg);padding:15px;border-radius:14px;
  box-shadow:0 15px 30px rgba(0,0,0,.25)
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px}
label{font-size:13px;font-weight:bold}
input,select,textarea,button{
  width:100%;padding:7px;border-radius:6px;border:1px solid #aaa
}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
.secondary{background:#059669}
.danger{background:#dc2626}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:12px;text-align:center}
.summary{
  border:2px solid #4f46e5;border-radius:10px;padding:12px;text-align:center
}
.topbar{display:flex;gap:10px;flex-wrap:wrap;justify-content:space-between}
</style>
</head>

<body>

<div class="container" id="reportBox">

<div class="topbar">
  <div>
    <button onclick="toggleDark()">üåô Dark</button>
    <button onclick="exportPDF()">üìÑ PDF</button>
    <button onclick="shareReport()">üì§ Share</button>
  </div>
</div>

<h3>Job Entry</h3>
<input type="hidden" id="docId">

<div class="grid">
<label>Date<input type="date" id="date"></label>
<label>QN<input id="qn"></label>
<label>Customer<input id="customer"></label>
<label>Location<input id="location"></label>
<label>Win Qty<input type="number" id="qty"></label>
<label>Total Sqft<input type="number" id="sqft"></label>
<label>Extra Payment<input type="number" id="extra"></label>
<label>Total Amount<input type="number" id="total"></label>
<label>Helpers<input type="number" id="helpers"></label>
<label>OT<input type="number" id="ot"></label>
<label>Company<input id="company"></label>
<label>Status<select id="status"><option>Completed</option><option>Pending</option></select></label>
<label>Payment<select id="payment"><option>Paid</option><option>Unpaid</option></select></label>
<label>Balance<input type="number" id="balance"></label>
<label>Job Type<select id="jobtype"><option>Solo</option><option>Partner</option></select></label>
<label>Holiday<select id="holiday"><option>No</option><option>Yes</option></select></label>
<label>Holiday Reason<textarea id="comment"></textarea></label>
</div>

<br>
<button onclick="saveData()">üíæ Save</button>
<button class="secondary" onclick="updateData()">‚úèÔ∏è Update</button>

<hr>

<h3>Filters</h3>
<div class="grid">
<label>Job Type<select id="filterJob" onchange="renderData()">
<option value="">All</option><option>Solo</option><option>Partner</option></select></label>
<label>Company<input id="filterCompany" onkeyup="renderData()"></label>
<label>Month<input type="month" id="filterMonth" onchange="renderData()"></label>
</div>

<h3>Summary</h3>
<div class="grid">
  <div class="summary">
    <h4>Total Earnings</h4>
    <h2 id="totalEarnings">‚Çπ0</h2>
  </div>
</div>

<h3>Report</h3>
<table>
<thead>
<tr>
<th>Date</th><th>QN</th><th>Customer</th><th>Company</th>
<th>Job</th><th>Total</th><th>Balance</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig={
  apiKey: "AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58",
  authDomain: "ayyappan-work-management.firebaseapp.com",
  projectId: "ayyappan-work-management"
};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();

let allData=[];

function toggleDark(){document.body.classList.toggle("dark")}

function saveData(){
  db.collection("jobs").add(getData()).then(()=>{clearForm()});
}

db.collection("jobs").onSnapshot(snap=>{
  allData=[];
  snap.forEach(d=>allData.push({id:d.id,...d.data()}));
  renderData();
});

function renderData(){
  tbody.innerHTML="";
  let sum=0;
  allData.forEach(d=>{
    if(filterJob.value && d.jobtype!==filterJob.value) return;
    if(filterCompany.value && !d.company.toLowerCase().includes(filterCompany.value.toLowerCase())) return;
    if(filterMonth.value && !d.date.startsWith(filterMonth.value)) return;
    sum+=Number(d.total||0);
    tbody.innerHTML+=`
    <tr>
      <td>${d.date}</td><td>${d.qn}</td><td>${d.customer}</td>
      <td>${d.company}</td><td>${d.jobtype}</td>
      <td>${d.total}</td><td>${d.balance}</td>
      <td>
        <button onclick="editData('${d.id}')">Edit</button>
        <button class="danger" onclick="deleteData('${d.id}')">Del</button>
      </td>
    </tr>`;
  });
  totalEarnings.innerText="‚Çπ"+sum.toLocaleString();
}

function editData(id){
  let d=allData.find(x=>x.id===id);
  docId.value=id;
  for(let k in d) if(document.getElementById(k)) document.getElementById(k).value=d[k];
  window.scrollTo({top:0,behavior:"smooth"});
}

function updateData(){
  if(!docId.value)return alert("Select record");
  db.collection("jobs").doc(docId.value).update(getData()).then(clearForm);
}

function deleteData(id){
  if(confirm("Delete?")) db.collection("jobs").doc(id).delete();
}

function getData(){
  return {
    date:date.value,qn:qn.value,customer:customer.value,location:location.value,
    qty:+qty.value||0,sqft:+sqft.value||0,extra:+extra.value||0,
    total:+total.value||0,helpers:+helpers.value||0,ot:+ot.value||0,
    company:company.value,status:status.value,payment:payment.value,
    balance:+balance.value||0,jobtype:jobtype.value,
    holiday:holiday.value,comment:comment.value
  }
}

function clearForm(){
  document.querySelectorAll("input,textarea").forEach(i=>i.value="");
  docId.value="";
}

function exportPDF(){html2pdf().from(reportBox).save("Job_Report.pdf")}
function shareReport(){
  navigator.share?navigator.share({title:"Job Report",url:location.href}):alert("Not supported");
}
</script>

</body>
</html>
