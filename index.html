<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ayyappan Manager | Pro Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(0,0,0,0.4);
            --card-bg: rgba(255, 255, 255, 0.03);
            --footer-bg: rgba(15, 23, 42, 0.95);
        }

        .light-mode {
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(255, 255, 255, 0.9);
            --card-bg: rgba(0, 0, 0, 0.02);
            --footer-bg: rgba(241, 245, 249, 0.95);
        }

        body { background: var(--bg-gradient); color: var(--text-main); min-height: 100vh; font-family: 'Inter', sans-serif; transition: 0.3s; }
        .glass { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); border-radius: 1rem; }
        .input-box { background: var(--input-bg); border: 1px solid #475569; border-radius: 0.6rem; padding: 0.7rem; color: inherit; width: 100%; outline: none; font-size: 14px; }
        label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .day-entry { background: var(--card-bg); border: 1px solid var(--glass-border); padding: 12px; border-radius: 12px; margin-bottom: 10px; position: relative; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 10px; }
        
        .excel-table-container { overflow-x: auto; border-radius: 12px; border: 1px solid var(--glass-border); background: var(--glass-bg); margin-bottom: 1.5rem; }
        .excel-table { width: 100%; border-collapse: collapse; font-size: 11px; white-space: nowrap; }
        .excel-table th { background: rgba(0,0,0,0.2); padding: 12px 10px; text-align: left; text-transform: uppercase; color: var(--text-dim); border-bottom: 2px solid var(--glass-border); font-weight: 800; }
        .excel-table td { padding: 10px; border-bottom: 1px solid var(--glass-border); }

        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 9px; font-weight: 900; text-transform: uppercase; }
        .status-Received { background: #059669; color: white; }
        .status-Billed { background: #dc2626; color: white; }
        .status-NotBilled { background: #4b5563; color: white; }

        #msgBox { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 200; min-width: 250px; text-align: center; border-radius: 12px; padding: 12px 24px; font-weight: bold; }
        
        .summary-footer { background: var(--footer-bg); border-top: 1px solid var(--glass-border); padding: 15px; border-radius: 20px 20px 0 0; }

        /* PDF View Specific */
        .pdf-modal-content { width: 100%; max-width: 500px; height: 80vh; display: flex; flex-direction: column; }
        #pdfIframe { flex-grow: 1; width: 100%; border: none; background: white; border-radius: 8px; }
    </style>
</head>
<body class="p-4">

    <div id="msgBox" class="bg-blue-600 text-white shadow-2xl"></div>

    <div class="max-w-4xl mx-auto">
        <div class="flex justify-between items-center mb-6">
            <h1 class="font-black text-2xl italic uppercase tracking-tighter text-blue-500">Ayyappan Pro <span class="text-white/40 font-normal text-xs not-italic lowercase">manager</span></h1>
            <div class="flex gap-3">
                <button id="themeToggle" onclick="toggleTheme()" class="w-10 h-10 glass flex items-center justify-center text-yellow-400"><i class="fas fa-moon"></i></button>
                <button onclick="toggleSettings()" class="w-10 h-10 glass flex items-center justify-center text-blue-400"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- Target Progress UI -->
        <div class="glass p-4 mb-6 border-l-4 border-yellow-500 shadow-lg">
            <div class="flex justify-between items-end mb-2">
                <label id="targetLabel" class="m-0 text-yellow-500 font-black">Monthly Target</label>
                <span id="targetRem" class="text-xs font-bold text-blue-400">â‚¹0</span>
            </div>
            <div class="w-full bg-black/10 h-3 rounded-full mb-2"><div id="targetBar" class="bg-yellow-500 h-full rounded-full transition-all duration-700" style="width:0%"></div></div>
            <div class="flex justify-between text-[10px] font-bold opacity-70"><span id="targetEarned">Earned: â‚¹0</span><span id="targetGoal">Goal: â‚¹0</span></div>
        </div>

        <!-- Entry Form -->
        <div class="glass p-5 mb-8 space-y-5 border-t-4 border-blue-600 shadow-2xl max-w-md mx-auto">
            <input type="hidden" id="editId">
            <div class="grid grid-cols-2 gap-4">
                <div><label>Date</label><input type="date" id="date" class="input-box"></div>
                <div><label>QN No</label><input type="text" id="qn" class="input-box" placeholder="QN-XXXX"></div>
            </div>
            
            <div class="flex items-center gap-4 bg-black/10 p-3 rounded-xl">
                <div class="flex items-center gap-2"><input type="checkbox" id="isHoliday" onchange="checkHoliday()" class="w-5 h-5 accent-red-500"><label class="m-0 text-red-500">Holiday</label></div>
                <select id="projectType" class="bg-transparent text-xs font-black text-blue-500 uppercase outline-none flex-1"><option value="Solo">Solo Work</option><option value="Partner">Partner Work</option></select>
            </div>
            
            <div id="workFields" class="space-y-4">
                <div><label>Company</label><select id="company" class="input-box"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label>Customer *</label><input type="text" id="customer" class="input-box"></div>
                    <div><label>Location</label><input type="text" id="location" class="input-box"></div>
                </div>

                <div class="bg-blue-600/5 p-4 rounded-xl border border-white/10">
                    <label class="mb-3 text-blue-400">Helper Logs</label>
                    <div id="dayLogsContainer"></div>
                    <button onclick="addDayRow()" class="w-full mt-2 text-[10px] bg-blue-600 text-white py-2 rounded uppercase font-black">+ Add Helper Row</button>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div><label>Windows</label><input type="number" id="windowQty" class="input-box"></div>
                    <div><label>Total Sqft</label><input type="number" id="totalSqft" oninput="calculate()" class="input-box"></div>
                    <div><label>Rate</label><input type="number" id="amtRate" oninput="calculate()" class="input-box"></div>
                </div>

                <div class="p-4 bg-black/20 rounded-2xl flex justify-between items-center border border-white/5">
                    <div><label class="m-0 text-green-500">Gross Bill</label><div id="resTotal" class="text-xl font-black text-green-500">â‚¹0</div></div>
                    <div class="text-right"><label class="m-0 text-red-500">Exp</label><div id="resExpDisplay" class="text-lg font-bold text-red-500">â‚¹0</div></div>
                </div>
            </div>

            <div id="holidayReasonDiv" class="hidden"><label>Reason</label><textarea id="holidayReason" class="input-box h-16"></textarea></div>

            <div class="p-3 bg-white/5 rounded-xl">
                <label>Payment Status</label>
                <div class="flex gap-1">
                    <button onclick="setPaymentStatus('Received')" id="btnReceived" class="flex-1 py-2 rounded-lg text-[9px] font-black uppercase border border-white/10 opacity-40">Received</button>
                    <button onclick="setPaymentStatus('Billed')" id="btnBilled" class="flex-1 py-2 rounded-lg text-[9px] font-black uppercase border border-white/10 opacity-40">Billed</button>
                    <button onclick="setPaymentStatus('Not Billed')" id="btnNotBilled" class="flex-1 py-2 rounded-lg text-[9px] font-black uppercase border border-white/10 opacity-40">Not Billed</button>
                    <input type="hidden" id="paymentStatus" value="Billed">
                </div>
            </div>
            
            <button onclick="saveData()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-all">Save Record</button>
        </div>

        <!-- History Area -->
        <div id="displayArea" class="excel-table-container">
            <table class="excel-table">
                <thead><tr><th>Date</th><th>QN</th><th>Customer</th><th>Type</th><th>Net</th><th>Status</th><th>Action</th></tr></thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- Sticky Footer Summary -->
        <div class="summary-footer sticky bottom-0 z-20 max-w-4xl mx-auto shadow-2xl">
            <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-black/20 p-3 rounded-xl border border-white/5"><label class="text-[9px]">Solo Profit</label><div id="tblSolo" class="font-black text-green-500">â‚¹0</div></div>
                <div class="bg-black/20 p-3 rounded-xl border border-white/5"><label class="text-[9px]">Partner Share</label><div id="tblPartnerMine" class="font-black text-blue-500">â‚¹0</div></div>
            </div>
            
            <div class="bg-blue-600 text-white p-4 rounded-2xl mb-4 flex justify-between items-center">
                <span class="font-black uppercase text-xs">Grand Total Profit</span>
                <span id="tblGrandTotal" class="text-xl font-black">â‚¹0</span>
            </div>

            <div id="monthlyBreakdownGrid" class="grid grid-cols-2 gap-2 mb-4"></div>

            <div class="grid grid-cols-2 gap-2">
                <select id="filterMonth" onchange="applyFilters()" class="input-box text-xs font-bold uppercase"></select>
                <select id="filterYear" onchange="applyFilters()" class="input-box text-xs font-bold uppercase"></select>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-4">
                <button onclick="exportHelperPDF()" class="bg-emerald-600 text-white py-3 rounded-xl font-black uppercase text-[10px]">Helper</button>
                <button onclick="exportSoloPDF()" class="bg-indigo-600 text-white py-3 rounded-xl font-black uppercase text-[10px]">Solo</button>
                <button onclick="exportPartnerPDF()" class="bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-[10px]">Partner</button>
            </div>
            <button onclick="shareWhatsApp()" class="w-full mt-2 bg-[#25D366] text-white py-3 rounded-xl font-black uppercase text-xs flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> WhatsApp Report</button>
        </div>
    </div>

    <!-- Modals -->
    <div id="settingsModal" class="modal">
        <div class="glass p-5 w-full max-w-sm space-y-4">
             <div class="flex justify-between items-center border-b border-white/10 pb-2">
                <h2 class="text-xs font-black text-blue-400 uppercase">Settings</h2>
                <button onclick="toggleSettings()"><i class="fas fa-times"></i></button>
            </div>
            <div class="space-y-3">
                <div><label>Monthly Target</label><input type="number" id="setTarget" class="input-box"></div>
                <div><label>Companies (comma sep)</label><input type="text" id="setCompanies" class="input-box"></div>
                <div><label>Helpers (comma sep)</label><input type="text" id="setHelpers" class="input-box"></div>
            </div>
            <button onclick="saveSettings()" class="w-full bg-blue-600 py-3 rounded-xl font-black text-white uppercase text-xs">Update</button>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div id="pdfModal" class="modal">
        <div class="glass p-4 pdf-modal-content">
            <div class="flex justify-between items-center mb-2">
                <span id="pdfTitle" class="text-xs font-black text-blue-500 uppercase">PDF Preview</span>
                <button onclick="closePdfModal()" class="text-white bg-red-500 w-6 h-6 rounded-full">Ã—</button>
            </div>
            <div id="pdfIframeContainer" class="flex-grow bg-white rounded overflow-hidden">
                <iframe id="pdfIframe"></iframe>
            </div>
            <button id="pdfDownloadBtn" class="w-full mt-3 bg-blue-600 text-white py-3 rounded-xl font-black uppercase text-xs">Download PDF</button>
        </div>
    </div>

    <script>
        const apiKey = "";
        const firebaseConfig = { apiKey: "AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58", authDomain: "ayyappan-work-management.firebaseapp.com", projectId: "ayyappan-work-management" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let allEntries = [];
        let globalSettings = { target: 50000, companies: "Sharp, Buildcon", helpers: "Ravi, Kumar" };
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        function showMessage(msg) {
            const box = document.getElementById('msgBox'); box.innerText = msg; box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        function setPaymentStatus(status) {
            document.getElementById('paymentStatus').value = status;
            const cleanStatus = status.replace(/\s/g, '');
            ['Received', 'Billed', 'NotBilled'].forEach(s => {
                const btn = document.getElementById(`btn${s}`);
                btn.classList.add('opacity-40'); btn.style.backgroundColor = 'transparent';
                if (s === cleanStatus) {
                    btn.classList.remove('opacity-40');
                    btn.style.backgroundColor = (s === 'Received') ? '#059669' : (s === 'Billed') ? '#dc2626' : '#4b5563';
                }
            });
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
        }

        function initTheme() {
            if (localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        }

        async function syncSettings() {
            const doc = await db.collection("appSettings").doc("userConfig").get();
            if(doc.exists) globalSettings = doc.data();
            document.getElementById('setTarget').value = globalSettings.target || 50000;
            document.getElementById('setCompanies').value = globalSettings.companies || "";
            document.getElementById('setHelpers').value = globalSettings.helpers || "";
            loadDropdowns();
        }

        async function saveSettings() {
            globalSettings = { 
                target: parseFloat(document.getElementById('setTarget').value) || 50000, 
                companies: document.getElementById('setCompanies').value, 
                helpers: document.getElementById('setHelpers').value 
            };
            await db.collection("appSettings").doc("userConfig").set(globalSettings);
            loadDropdowns(); toggleSettings(); applyFilters();
        }

        function loadDropdowns() {
            const comps = (globalSettings.companies || "").split(',');
            document.getElementById('company').innerHTML = comps.map(c => `<option>${c.trim()}</option>`).join('');
            const currentYear = new Date().getFullYear();
            ['filterYear', 'filterMonth'].forEach(id => {
                const el = document.getElementById(id);
                if(el && el.options.length === 0) {
                    if(id.includes('Year')) { for(let y = currentYear; y >= 2024; y--) el.add(new Option(y, y)); }
                    else monthNames.forEach((m, i) => el.add(new Option(m, i)));
                }
            });
        }

        function addDayRow(data = null) {
            const container = document.getElementById('dayLogsContainer');
            const dayDiv = document.createElement('div'); dayDiv.className = "day-entry";
            dayDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="date" class="input-box h-8 py-0 d-hdate" value="${data?.hDate || document.getElementById('date').value}">
                    <select class="input-box h-8 py-0 d-helper"></select>
                </div>
                <div class="grid grid-cols-4 gap-1">
                    <input type="number" class="input-box h-8 d-sal px-1 text-center" oninput="calculate()" placeholder="Sal" value="${data?.sal || ''}">
                    <input type="number" step="0.5" class="input-box h-8 d-ot px-1 text-center" oninput="calculate()" placeholder="OT" value="${data?.ot || ''}">
                    <input type="number" class="input-box h-8 d-pet px-1 text-center" oninput="calculate()" placeholder="Pet" value="${data?.pet || ''}">
                    <input type="number" class="input-box h-8 d-food px-1 text-center" oninput="calculate()" placeholder="Food" value="${data?.food || ''}">
                </div>
                <button onclick="this.parentElement.remove(); calculate()" class="absolute -top-1 -right-1 bg-red-600 text-white w-4 h-4 rounded-full text-[10px]">Ã—</button>`;
            container.appendChild(dayDiv);
            const helps = (globalSettings.helpers || "").split(',');
            const sel = dayDiv.querySelector('.d-helper');
            sel.innerHTML = helps.map(h => `<option>${h.trim()}</option>`).join('');
            if(data) sel.value = data.helper;
            calculate();
        }

        function calculate() {
            const val = (parseFloat(document.getElementById('totalSqft').value) || 0) * (parseFloat(document.getElementById('amtRate').value) || 0);
            let totalWages = 0; 
            document.querySelectorAll('.day-entry').forEach(row => { 
                const s = parseFloat(row.querySelector('.d-sal').value) || 0;
                totalWages += s + (s/2 * (parseFloat(row.querySelector('.d-ot').value) || 0)) + (parseFloat(row.querySelector('.d-pet').value) || 0) + (parseFloat(row.querySelector('.d-food').value) || 0);
            });
            document.getElementById('resTotal').innerText = "â‚¹" + Math.round(val).toLocaleString();
            document.getElementById('resExpDisplay').innerText = "â‚¹" + Math.round(totalWages).toLocaleString();
            return { val, totalWages };
        }

        async function saveData() {
            const isH = document.getElementById('isHoliday').checked;
            const cust = document.getElementById('customer').value.trim();
            if (!isH && !cust) { showMessage("Customer is Required"); return; }
            const cal = calculate(), logs = [];
            document.querySelectorAll('.day-entry').forEach(row => { 
                logs.push({ 
                    hDate: row.querySelector('.d-hdate').value, 
                    helper: row.querySelector('.d-helper').value, 
                    sal: row.querySelector('.d-sal').value, 
                    ot: row.querySelector('.d-ot').value, 
                    pet: row.querySelector('.d-pet').value, 
                    food: row.querySelector('.d-food').value 
                }); 
            });
            const data = { 
                date: document.getElementById('date').value, 
                qn: document.getElementById('qn').value, 
                customer: cust, 
                location: document.getElementById('location').value, 
                projectType: document.getElementById('projectType').value, 
                company: document.getElementById('company').value, 
                windowQty: document.getElementById('windowQty').value, 
                totalSqft: document.getElementById('totalSqft').value, 
                amtRate: document.getElementById('amtRate').value, 
                total: cal.val, 
                logs, 
                isHoliday: isH, 
                comment: isH ? document.getElementById('holidayReason').value : "", 
                paymentStatus: document.getElementById('paymentStatus').value
            };
            const id = document.getElementById('editId').value;
            if(id) await db.collection("workLogs").doc(id).update(data); 
            else await db.collection("workLogs").add(data);
            location.reload();
        }

        db.collection("workLogs").orderBy("date", "desc").onSnapshot(snap => { 
            allEntries = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            applyFilters();
        });

        function applyFilters() {
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            let currentEarned = 0, soloEarn = 0, partnerEarn = 0, profit = 0, sqft = 0;
            const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = "";
            allEntries.forEach(d => {
                const eD = new Date(d.date);
                if((eD.getMonth() == fM) && (eD.getFullYear() == fY)) {
                    let siteExp = 0;
                    d.logs?.forEach(l => { 
                        const sVal = parseFloat(l.sal) || 0;
                        siteExp += sVal + (sVal/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
                    });
                    const net = (parseFloat(d.total)||0) - siteExp;
                    const share = d.projectType === 'Partner' ? (net/2) : net;
                    if(!d.isHoliday) { 
                        currentEarned += share; 
                        profit += net; 
                        sqft += (parseFloat(d.totalSqft)||0);
                        if(d.projectType === 'Partner') partnerEarn += share; else soloEarn += share; 
                    }
                    
                    const pStatus = d.paymentStatus || 'Billed';
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${d.date.substring(5)}</td><td>${d.qn||'-'}</td><td class="font-bold">${d.isHoliday?'HOL':d.customer}</td><td class="text-[8px] font-black">${d.projectType[0]}</td><td class="font-bold">â‚¹${Math.round(share).toLocaleString()}</td><td><span class=\"status-badge status-${pStatus.replace(/\s/g,'')}\">${pStatus}</span></td><td><button onclick=\"editDoc('${d.id}')\" class=\"text-blue-500\"><i class=\"fas fa-edit\"></i></button></td>`;
                    tbody.appendChild(row);
                }
            });
            document.getElementById('tblSolo').innerText = "â‚¹" + Math.round(soloEarn).toLocaleString();
            document.getElementById('tblPartnerMine').innerText = "â‚¹" + Math.round(partnerEarn).toLocaleString();
            document.getElementById('tblGrandTotal').innerText = "â‚¹" + Math.round(soloEarn + partnerEarn).toLocaleString();
            updateTargetUI(currentEarned);
            document.getElementById('monthlyBreakdownGrid').innerHTML = `
                <div class="bg-blue-600/10 p-3 rounded-xl border border-blue-500/20"><div class="text-[9px] opacity-50 uppercase">Profit</div><div class="text-xl font-black text-blue-500">â‚¹${Math.round(profit).toLocaleString()}</div></div>
                <div class="bg-green-600/10 p-3 rounded-xl border border-green-500/20"><div class="text-[9px] opacity-50 uppercase">Sqft</div><div class="text-xl font-black text-green-500">${sqft}</div></div>`;
        }

        function updateTargetUI(earned) {
            let target = parseFloat(globalSettings.target) || 50000;
            const percent = Math.min((earned / target) * 100, 100);
            document.getElementById('targetBar').style.width = percent + "%";
            document.getElementById('targetEarned').innerText = `Earned: â‚¹${Math.round(earned).toLocaleString()}`;
            document.getElementById('targetGoal').innerText = `Goal: â‚¹${target.toLocaleString()}`;
            document.getElementById('targetRem').innerText = `â‚¹${Math.max(0, Math.round(target - earned)).toLocaleString()}`;
        }

        // PDF View/Download Logic for Mobile
        function showPdf(doc, filename) {
            const pdfData = doc.output('datauristring');
            const modal = document.getElementById('pdfModal');
            const iframe = document.getElementById('pdfIframe');
            const downloadBtn = document.getElementById('pdfDownloadBtn');
            
            iframe.src = pdfData;
            modal.style.display = 'flex';
            
            downloadBtn.onclick = () => {
                doc.save(filename);
                closePdfModal();
            };
        }

        function closePdfModal() {
            document.getElementById('pdfModal').style.display = 'none';
            document.getElementById('pdfIframe').src = '';
        }

        function exportHelperPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('p'); 
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            doc.text(`Helper Report: ${monthNames[fM]} ${fY}`, 14, 15);
            const rows = [];
            allEntries.forEach(entry => {
                const ed = new Date(entry.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && entry.logs?.length > 0) {
                    entry.logs.forEach(log => {
                        const s = parseFloat(log.sal) || 0;
                        const tot = s + (s/2 * (parseFloat(log.ot)||0)) + (parseFloat(log.pet)||0) + (parseFloat(log.food)||0);
                        rows.push([log.hDate || entry.date, log.helper, entry.customer || 'Site', `Rs. ${s}`, log.ot || 0, `Rs. ${Math.round(tot)}`]);
                    });
                }
            });
            doc.autoTable({ startY: 20, head: [['Date', 'Helper', 'Site', 'Sal', 'OT', 'Total']], body: rows });
            showPdf(doc, `Helpers_${monthNames[fM]}.pdf`);
        }

        function exportSoloPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); 
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            doc.text(`Solo Report: ${monthNames[fM]} ${fY}`, 14, 15);
            const rows = [];
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && !d.isHoliday && d.projectType === 'Solo') {
                    let exp = 0; d.logs?.forEach(l => { const s = parseFloat(l.sal)||0; exp += s + (s/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0); });
                    rows.push([d.date, d.qn || '-', d.customer, d.location || '-', `Rs. ${Math.round(d.total)}`, `Rs. ${Math.round(exp)}`, `Rs. ${Math.round(d.total - exp)}`]);
                }
            });
            doc.autoTable({ startY: 20, head: [['Date', 'QN', 'Customer', 'Location', 'Bill', 'Exp', 'Net']], body: rows });
            showPdf(doc, `Solo_${monthNames[fM]}.pdf`);
        }

        function exportPartnerPDF() {
            const { jsPDF } = window.jspdf; const doc = new jsPDF('l'); 
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            doc.text(`Partner Report: ${monthNames[fM]} ${fY}`, 14, 15);
            const rows = [];
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && !d.isHoliday && d.projectType === 'Partner') {
                    let exp = 0; d.logs?.forEach(l => { const s = parseFloat(l.sal)||0; exp += s + (s/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0); });
                    rows.push([d.date, d.qn || '-', d.customer, d.location || '-', `Rs. ${Math.round(d.total)}`, `Rs. ${Math.round(exp)}`, `Rs. ${Math.round((d.total - exp)/2)}`]);
                }
            });
            doc.autoTable({ startY: 20, head: [['Date', 'QN', 'Customer', 'Location', 'Bill', 'Exp', 'My Share']], body: rows });
            showPdf(doc, `Partner_${monthNames[fM]}.pdf`);
        }

        function editDoc(id) {
            const d = allEntries.find(e => e.id === id);
            document.getElementById('editId').value = id; document.getElementById('date').value = d.date; document.getElementById('customer').value = d.customer; document.getElementById('qn').value = d.qn || "";
            document.getElementById('location').value = d.location || ""; document.getElementById('windowQty').value = d.windowQty || "";
            document.getElementById('totalSqft').value = d.totalSqft || ""; document.getElementById('amtRate').value = d.amtRate || "";
            document.getElementById('projectType').value = d.projectType; document.getElementById('isHoliday').checked = d.isHoliday; setPaymentStatus(d.paymentStatus || 'Billed');
            document.getElementById('dayLogsContainer').innerHTML = ""; (d.logs || []).forEach(l => addDayRow(l));
            checkHoliday(); calculate(); window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function toggleSettings() { const m = document.getElementById('settingsModal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
        function checkHoliday() { const isH = document.getElementById('isHoliday').checked; document.getElementById('workFields').style.display = isH ? 'none' : 'block'; document.getElementById('holidayReasonDiv').classList.toggle('hidden', !isH); }

        function shareWhatsApp() {
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            let msg = `*ðŸ“Š Work Report: ${monthNames[fM]} ${fY}*\nSolo: ${document.getElementById('tblSolo').innerText}\nPartner: ${document.getElementById('tblPartnerMine').innerText}\n*TOTAL: ${document.getElementById('tblGrandTotal').innerText}*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        window.onload = async () => { 
            const now = new Date(); initTheme();
            document.getElementById('date').valueAsDate = now; 
            await syncSettings(); 
            document.getElementById('filterMonth').value = now.getMonth();
            document.getElementById('filterYear').value = now.getFullYear();
            applyFilters();
        };
    </script>
</body>
</html>
