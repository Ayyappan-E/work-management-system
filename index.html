<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayyappan Manager | Pro Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --glass-bg: rgba(30, 41, 59, 0.7);
            --accent: #3b82f6;
        }

        body {
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
        }

        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }

        .input-field:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 3px solid var(--accent);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* PDF Preview Modal Styles */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 100; align-items: center; justify-content: center; padding: 10px; }
        .glass-modal { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .pdf-modal-container { width: 100%; max-width: 500px; height: 85vh; display: flex; flex-direction: column; }
        #pdfIframe { flex-grow: 1; width: 100%; border: none; background: white; border-radius: 8px; }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto space-y-6">
        
        <!-- Header Section -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-black tracking-tight text-white flex items-center gap-3">
                    <i class="fas fa-layer-group text-blue-500"></i>
                    AYYAPPAN <span class="text-blue-500">MANAGER</span>
                </h1>
                <p id="kuralDisplay" class="text-sm text-slate-400 mt-1 italic font-serif">Loading wisdom...</p>
            </div>
            
            <div class="flex items-center gap-3">
                <select id="filterMonth" class="input-field px-4 py-2 rounded-lg text-sm"></select>
                <select id="filterYear" class="input-field px-4 py-2 rounded-lg text-sm"></select>
                <button onclick="shareWhatsApp()" class="bg-green-600 hover:bg-green-700 text-white p-2.5 rounded-lg transition">
                    <i class="fab fa-whatsapp text-lg"></i>
                </button>
            </div>
        </header>

        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="glass-panel p-5 flex flex-col justify-between h-32 border-l-4 border-blue-500">
                <span class="text-xs uppercase font-bold text-slate-400 tracking-widest">Total Net Profit</span>
                <div id="tblGrandTotal" class="text-2xl font-black text-white">â‚¹0</div>
            </div>
            <div class="glass-panel p-5 flex flex-col justify-between h-32 border-l-4 border-emerald-500">
                <span class="text-xs uppercase font-bold text-slate-400 tracking-widest">Total Sqft</span>
                <div id="totalSqftDisplay" class="text-2xl font-black text-white">0</div>
            </div>
            <div class="glass-panel p-5 flex flex-col justify-between h-32 border-l-4 border-purple-500">
                <span class="text-xs uppercase font-bold text-slate-400 tracking-widest">Solo Earn</span>
                <div id="tblSolo" class="text-2xl font-black text-white">â‚¹0</div>
            </div>
            <div class="glass-panel p-5 flex flex-col justify-between h-32 border-l-4 border-orange-500">
                <span class="text-xs uppercase font-bold text-slate-400 tracking-widest">Partner Mine</span>
                <div id="tblPartnerMine" class="text-2xl font-black text-white">â‚¹0</div>
            </div>
        </div>

        <!-- Main Workspace -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Entry Form -->
            <div class="glass-panel p-6 space-y-4">
                <h2 class="text-lg font-bold flex items-center gap-2 mb-4">
                    <i class="fas fa-plus-circle text-blue-500"></i> New Entry
                </h2>
                <div class="grid grid-cols-2 gap-3">
                    <div class="col-span-2">
                        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Work Date</label>
                        <input type="date" id="date" class="input-field w-full p-2.5 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">QN No</label>
                        <input type="text" id="qnNo" placeholder="QN-2024" class="input-field w-full p-2.5 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Company</label>
                        <input type="text" id="company" placeholder="Client Name" class="input-field w-full p-2.5 rounded-lg text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Location</label>
                        <input type="text" id="location" placeholder="Site Location" class="input-field w-full p-2.5 rounded-lg text-sm">
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5 space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Sqft</label>
                            <input type="number" id="sqft" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-[10px] uppercase font-bold text-slate-500 mb-1 block">Rate</label>
                            <input type="number" id="rate" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="bg-blue-600/10 p-3 rounded-lg flex justify-between items-center">
                        <span class="text-xs font-bold text-blue-400">GROSS BILL</span>
                        <span id="grossBill" class="font-black text-white">â‚¹0</span>
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5 space-y-3">
                    <h3 class="text-xs font-bold text-slate-400">HELPER EXPENSES</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <input type="number" id="helperWage" placeholder="Wage" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                        <input type="number" id="ot" placeholder="OT" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                        <input type="number" id="food" placeholder="Food" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                        <input type="number" id="petrol" placeholder="Petrol" oninput="calculate()" class="input-field w-full p-2.5 rounded-lg text-sm">
                    </div>
                </div>

                <div class="pt-4 border-t border-white/5 flex items-center gap-4">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="isPartner" class="accent-blue-500">
                        <span class="text-xs font-bold">Partner Work</span>
                    </label>
                    <button id="saveBtn" onclick="saveData()" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition">
                        SAVE DATA
                    </button>
                </div>
            </div>

            <!-- List View -->
            <div class="lg:col-span-2 glass-panel p-6 overflow-hidden flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-list-ul text-blue-500"></i> Records
                    </h2>
                    <div class="flex gap-2">
                        <button onclick="exportHelperPDF()" class="text-[10px] bg-emerald-700 px-3 py-1 rounded-md hover:bg-emerald-600 transition">Helper Report</button>
                        <button onclick="exportSoloPDF()" class="text-[10px] bg-indigo-700 px-3 py-1 rounded-md hover:bg-indigo-600 transition">Solo Report</button>
                        <button onclick="exportPartnerPDF()" class="text-[10px] bg-blue-700 px-3 py-1 rounded-md hover:bg-blue-600 transition">Partner Report</button>
                    </div>
                </div>

                <div class="overflow-x-auto flex-1">
                    <table class="w-full text-left text-sm border-separate border-spacing-y-2">
                        <thead>
                            <tr class="text-slate-500 uppercase text-[10px] tracking-wider font-black">
                                <th class="px-4 pb-2">Date / Info</th>
                                <th class="px-4 pb-2">Billing</th>
                                <th class="px-4 pb-2">Expense</th>
                                <th class="px-4 pb-2">Net</th>
                                <th class="px-4 pb-2 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="dataTable">
                            <!-- Rows loaded via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <!-- PDF Modal Structure -->
    <div id="pdfModal" class="modal">
        <div class="glass-modal p-4 pdf-modal-container">
            <div class="flex justify-between items-center mb-2">
                <span class="text-xs font-black text-blue-400 uppercase tracking-widest">Preview Report</span>
                <button onclick="closePdfModal()" class="text-white bg-red-600 w-8 h-8 rounded-full flex items-center justify-center font-bold">Ã—</button>
            </div>
            <div class="flex-grow bg-white rounded overflow-hidden shadow-inner">
                <iframe id="pdfIframe"></iframe>
            </div>
            <button id="pdfDownloadBtn" class="w-full mt-3 bg-blue-600 text-white py-4 rounded-xl font-black uppercase text-xs">Download PDF File</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Use empty string as requested for potential environment replacement
        const apiKey = "";
        const firebaseConfig = {
            apiKey: apiKey,
            authDomain: "ayyappan-manager.firebaseapp.com",
            projectId: "ayyappan-manager",
            storageBucket: "ayyappan-manager.appspot.com",
            messagingSenderId: "367375252877",
            appId: "1:367375252877:web:2c1613ca9c80f493541300"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let currentRecords = [];

        // Calculation Logic
        function calculate() {
            const sqft = parseFloat(document.getElementById('sqft').value) || 0;
            const rate = parseFloat(document.getElementById('rate').value) || 0;
            const wage = parseFloat(document.getElementById('helperWage').value) || 0;
            const ot = parseFloat(document.getElementById('ot').value) || 0;
            const food = parseFloat(document.getElementById('food').value) || 0;
            const petrol = parseFloat(document.getElementById('petrol').value) || 0;

            const gross = sqft * rate;
            const helperTotal = wage + ot + food + petrol;
            
            document.getElementById('grossBill').innerText = `â‚¹${gross.toLocaleString()}`;
            return { gross, helperTotal };
        }

        async function saveData() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

            const { gross, helperTotal } = calculate();
            const data = {
                date: document.getElementById('date').value,
                qnNo: document.getElementById('qnNo').value,
                company: document.getElementById('company').value,
                location: document.getElementById('location').value,
                sqft: parseFloat(document.getElementById('sqft').value) || 0,
                rate: parseFloat(document.getElementById('rate').value) || 0,
                grossBill: gross,
                helperWage: parseFloat(document.getElementById('helperWage').value) || 0,
                ot: parseFloat(document.getElementById('ot').value) || 0,
                food: parseFloat(document.getElementById('food').value) || 0,
                petrol: parseFloat(document.getElementById('petrol').value) || 0,
                helperTotal: helperTotal,
                isPartner: document.getElementById('isPartner').checked,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                await db.collection('works').add(data);
                resetForm();
                loadData();
            } catch (e) {
                console.error(e);
            } finally {
                btn.disabled = false;
                btn.innerText = 'SAVE DATA';
            }
        }

        function resetForm() {
            ['qnNo', 'company', 'location', 'sqft', 'rate', 'helperWage', 'ot', 'food', 'petrol'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('isPartner').checked = false;
            calculate();
        }

        async function loadData() {
            const month = parseInt(document.getElementById('filterMonth').value);
            const year = parseInt(document.getElementById('filterYear').value);
            
            const start = new Date(year, month, 1).toISOString().split('T')[0];
            const end = new Date(year, month + 1, 0).toISOString().split('T')[0];

            const snapshot = await db.collection('works')
                .where('date', '>=', start)
                .where('date', '<=', end)
                .orderBy('date', 'desc')
                .get();

            currentRecords = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            renderTable();
            updateSummary();
        }

        function renderTable() {
            const tbody = document.getElementById('dataTable');
            tbody.innerHTML = currentRecords.map(item => `
                <tr class="bg-white/5 rounded-lg group transition hover:bg-white/10">
                    <td class="px-4 py-3 rounded-l-xl">
                        <div class="font-bold text-white">${item.date}</div>
                        <div class="text-[10px] text-slate-400">${item.company} | ${item.qnNo}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs">â‚¹${item.grossBill.toLocaleString()}</div>
                        <div class="text-[10px] text-slate-500">${item.sqft} @ ${item.rate}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="text-xs text-red-400">â‚¹${item.helperTotal.toLocaleString()}</div>
                    </td>
                    <td class="px-4 py-3">
                        <div class="font-black ${item.isPartner ? 'text-orange-400' : 'text-blue-400'}">
                            â‚¹${(item.grossBill - item.helperTotal).toLocaleString()}
                            ${item.isPartner ? '<span class="text-[9px] block">Partner</span>' : ''}
                        </div>
                    </td>
                    <td class="px-4 py-3 text-right rounded-r-xl">
                        <button onclick="deleteDoc('${item.id}')" class="opacity-0 group-hover:opacity-100 transition text-slate-500 hover:text-red-500 p-2">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function updateSummary() {
            let totalProfit = 0, totalSqft = 0, solo = 0, partner = 0;
            currentRecords.forEach(r => {
                const profit = r.grossBill - r.helperTotal;
                totalProfit += profit;
                totalSqft += r.sqft;
                if(r.isPartner) partner += (profit / 2);
                else solo += profit;
            });

            document.getElementById('tblGrandTotal').innerText = `â‚¹${Math.round(totalProfit).toLocaleString()}`;
            document.getElementById('totalSqftDisplay').innerText = totalSqft.toLocaleString();
            document.getElementById('tblSolo').innerText = `â‚¹${Math.round(solo).toLocaleString()}`;
            document.getElementById('tblPartnerMine').innerText = `â‚¹${Math.round(partner).toLocaleString()}`;
        }

        async function deleteDoc(id) {
            if(confirm('Delete this record?')) {
                await db.collection('works').doc(id).delete();
                loadData();
            }
        }

        async function fetchKural() {
            try {
                const id = Math.floor(Math.random() * 1330) + 1;
                const res = await fetch(`https://api-thirukkural.vercel.app/api?num=${id}`);
                const data = await res.json();
                document.getElementById('kuralDisplay').innerText = `"${data.line1} ${data.line2}"`;
            } catch (e) {
                document.getElementById('kuralDisplay').innerText = "Labor is the only wealth.";
            }
        }

        function shareWhatsApp() {
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            let msg = `*ðŸ“Š Work Report: ${monthNames[fM]} ${fY}*\n`;
            msg += `Solo Earnings: ${document.getElementById('tblSolo').innerText}\n`;
            msg += `Partner Share: ${document.getElementById('tblPartnerMine').innerText}\n`;
            msg += `*Total Net: ${document.getElementById('tblGrandTotal').innerText}*`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        // --- UPDATED PDF MODULE LOGIC ---
        
        function openPdfPreview(doc, filename) {
            const pdfDataUri = doc.output('datauristring');
            const modal = document.getElementById('pdfModal');
            const iframe = document.getElementById('pdfIframe');
            const downloadBtn = document.getElementById('pdfDownloadBtn');
            
            iframe.src = pdfDataUri;
            modal.style.display = 'flex';
            
            downloadBtn.onclick = () => {
                doc.save(filename);
                closePdfModal();
            };
        }

        function closePdfModal() {
            document.getElementById('pdfModal').style.display = 'none';
            document.getElementById('pdfIframe').src = '';
        }

        function exportHelperPDF() {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('p'); 
            const monthIdx = document.getElementById('filterMonth').value;
            const month = monthNames[monthIdx];
            
            doc.setFontSize(18);
            doc.text(`Helper Wages Report: ${month}`, 14, 15);
            
            const rows = currentRecords
                .filter(r => r.helperTotal > 0)
                .map(r => [
                    r.date, 
                    'Helpers', 
                    r.company, 
                    `Rs. ${r.helperWage}`, 
                    r.ot, 
                    `Rs. ${Math.round(r.helperTotal)}`
                ]);

            doc.autoTable({ 
                startY: 25, 
                head: [['Date', 'Personnel', 'Site', 'Base Wage', 'OT', 'Total Cost']], 
                body: rows,
                theme: 'grid',
                headStyles: { fillColor: [5, 150, 105] }
            });
            
            openPdfPreview(doc, `Helpers_${month}.pdf`);
        }

        function exportSoloPDF() {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('l'); 
            const monthIdx = document.getElementById('filterMonth').value;
            const month = monthNames[monthIdx];
            
            doc.setFontSize(16);
            doc.text(`Solo Work Statement: ${month}`, 14, 15);
            
            const rows = currentRecords
                .filter(r => !r.isPartner)
                .map(r => [
                    r.date, 
                    r.qnNo || '-', 
                    r.company, 
                    `Rs. ${Math.round(r.grossBill)}`, 
                    `Rs. ${Math.round(r.helperTotal)}`, 
                    `Rs. ${Math.round(r.grossBill - r.helperTotal)}`
                ]);

            doc.autoTable({ 
                startY: 20, 
                head: [['Date', 'QN', 'Customer', 'Gross Bill', 'Exp', 'Net Profit']], 
                body: rows,
                headStyles: { fillColor: [79, 70, 229] }
            });
            
            openPdfPreview(doc, `Solo_Report_${month}.pdf`);
        }

        function exportPartnerPDF() {
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF('l'); 
            const monthIdx = document.getElementById('filterMonth').value;
            const month = monthNames[monthIdx];
            
            doc.setFontSize(16);
            doc.text(`Partner Split Statement (50/50): ${month}`, 14, 15);
            
            const rows = currentRecords
                .filter(r => r.isPartner)
                .map(r => {
                    const net = r.grossBill - r.helperTotal;
                    return [
                        r.date, 
                        r.company, 
                        `Rs. ${Math.round(r.grossBill)}`, 
                        `Rs. ${Math.round(r.helperTotal)}`, 
                        `Rs. ${Math.round(net)}`, 
                        `Rs. ${Math.round(net/2)}`
                    ];
                });

            doc.autoTable({ 
                startY: 20, 
                head: [['Date', 'Customer', 'Bill', 'Exp', 'Total Profit', 'My 50% Share']], 
                body: rows,
                headStyles: { fillColor: [37, 99, 235] }
            });
            
            openPdfPreview(doc, `Partner_Report_${month}.pdf`);
        }

        // Initialize Selects
        window.onload = () => {
            const now = new Date();
            const fM = document.getElementById('filterMonth');
            const fY = document.getElementById('filterYear');

            monthNames.forEach((m, i) => {
                fM.innerHTML += `<option value="${i}" ${i === now.getMonth() ? 'selected' : ''}>${m}</option>`;
            });

            for(let y = 2023; y <= 2030; y++) {
                fY.innerHTML += `<option value="${y}" ${y === now.getFullYear() ? 'selected' : ''}>${y}</option>`;
            }

            document.getElementById('date').valueAsDate = now;
            
            fM.onchange = loadData;
            fY.onchange = loadData;

            fetchKural();
            loadData();
        };
    </script>
</body>
</html>
