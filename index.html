<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Ayyappan Work Management</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
:root{--bg:#fff;--text:#000}
.dark{--bg:#111;--text:#fff}
body{margin:0;font-family:Arial;background:#0f172a;color:var(--text)}
.container{
 max-width:1200px;margin:16px auto;background:var(--bg);
 padding:16px;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.35)
}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
label{font-size:13px;font-weight:bold}
input,select,textarea,button{
 width:100%;padding:7px;border-radius:6px;border:1px solid #aaa
}
button{background:#4f46e5;color:#fff;border:none;cursor:pointer}
.danger{background:#dc2626}
.secondary{background:#059669}
.summaryBox{
 border:2px solid #4f46e5;border-radius:12px;padding:12px;text-align:center
}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:12px}
th,td{border:1px solid #ccc;padding:6px;text-align:center}

/* üì± Mobile table ‚Üí cards */
@media(max-width:768px){
 table,thead{display:none}
 .card{
   border:1px solid #ccc;border-radius:10px;padding:10px;margin-bottom:10px
 }
 .card div{font-size:13px;margin:3px 0}
}

.hidden{display:none}
</style>
</head>

<body>
<div class="container">

<h2>Ayyappan Work Management</h2>

<!-- FORM -->
<div class="grid">
<label>Date<input type="date" id="date"></label>
<label>QN<input id="qn"></label>
<label>Customer<input id="customer"></label>
<label>Location<input id="location"></label>

<label>Holiday?
<select id="holiday" onchange="toggleHoliday()">
<option value="no">No</option>
<option value="yes">Yes</option>
</select></label>

<label class="holidayOnly hidden">Holiday Reason<textarea id="holidayReason"></textarea></label>

<label class="workOnly">Sqft<input type="number" id="sqft" oninput="calc()"></label>
<label class="workOnly">Rate<input type="number" id="rate" oninput="calc()"></label>
<label class="workOnly">Extra<input type="number" id="extra" oninput="calc()"></label>
<label class="workOnly">Total<input id="total" readonly></label>

<label class="workOnly">Company<input id="company"></label>
<label class="workOnly">Payment Status
<select id="paystatus">
<option>Unpaid</option><option>Partial</option><option>Paid</option>
</select></label>
<label class="workOnly">Balance<input id="balance"></label>
</div>

<br>
<button onclick="saveData()">Save / Update</button>

<hr>

<!-- SUMMARY -->
<div class="grid">
<div class="summaryBox">
<h3>Total Earnings</h3>
<h2 id="sum">‚Çπ0</h2>
</div>
<div class="summaryBox">
<h3>Balance Pending</h3>
<h2 id="pending">‚Çπ0</h2>
</div>
<div class="summaryBox">
<h3>Company Totals</h3>
<div id="companyTotals"></div>
</div>
</div>

<hr>

<!-- REPORT -->
<h3>Report</h3>
<table>
<thead>
<tr>
<th>Date</th><th>Customer</th><th>Company</th>
<th>Sqft</th><th>Total</th><th>Balance</th><th>Action</th>
</tr>
</thead>
<tbody id="tbody"></tbody>
</table>

<div id="cards"></div>

<br>
<button onclick="exportPDF()">Export PDF</button>
<button onclick="toggleDark()">Dark Mode</button>

</div>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
firebase.initializeApp({
 apiKey:"AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58",
 authDomain:"ayyappan-work-management.firebaseapp.com",
 projectId:"ayyappan-work-management"
});
const db=firebase.firestore();
let data=[],editId=null;

function toggleHoliday(){
 const h=holiday.value==="yes";
 document.querySelectorAll(".workOnly").forEach(e=>e.style.display=h?"none":"block");
 document.querySelector(".holidayOnly").classList.toggle("hidden",!h);
}

function calc(){
 total.value=(+sqft.value||0)*(+rate.value||0)+(+extra.value||0);
}

function saveData(){
 let payload;
 if(holiday.value==="yes"){
   payload={date:date.value,type:"Holiday",reason:holidayReason.value,total:0,balance:0};
 }else{
   payload={
     date:date.value,type:"Work",qn:qn.value,customer:customer.value,
     location:location.value,sqft:+sqft.value||0,rate:+rate.value||0,
     extra:+extra.value||0,total:+total.value||0,
     company:company.value,paystatus:paystatus.value,
     balance:+balance.value||0
   };
 }
 editId?db.collection("jobs").doc(editId).set(payload):
        db.collection("jobs").add(payload);
 editId=null;
}

db.collection("jobs").onSnapshot(s=>{
 data=[];s.forEach(d=>data.push({id:d.id,...d.data()}));
 render();
});

function editRow(d){
 editId=d.id;
 Object.keys(d).forEach(k=>{
   if(document.getElementById(k)) document.getElementById(k).value=d[k];
 });
}

function delRow(id){
 if(confirm("Delete this record?"))
 db.collection("jobs").doc(id).delete();
}

function render(){
 tbody.innerHTML="";cards.innerHTML="";
 let sum=0,bal=0,companySum={};

 data.forEach(d=>{
   if(d.type==="Work"){
     sum+=d.total||0;
     bal+=d.balance||0;
     companySum[d.company]=(companySum[d.company]||0)+(d.total||0);
   }

   tbody.innerHTML+=`
   <tr>
   <td>${d.date||"-"}</td>
   <td>${d.customer||"-"}</td>
   <td>${d.company||"-"}</td>
   <td>${d.sqft||"-"}</td>
   <td>${d.total||0}</td>
   <td>${d.balance||0}</td>
   <td>
   <button class="secondary" onclick='editRow(${JSON.stringify(d)})'>‚úèÔ∏è</button>
   <button class="danger" onclick="delRow('${d.id}')">üóë</button>
   </td>
   </tr>`;

   cards.innerHTML+=`
   <div class="card">
   <div><b>Date:</b> ${d.date}</div>
   <div><b>Customer:</b> ${d.customer||"-"}</div>
   <div><b>Total:</b> ‚Çπ${d.total||0}</div>
   <button onclick='editRow(${JSON.stringify(d)})'>Edit</button>
   </div>`;
 });

 sum.innerText="‚Çπ"+sum.toLocaleString();
 pending.innerText="‚Çπ"+bal.toLocaleString();

 companyTotals.innerHTML="";
 Object.keys(companySum).forEach(c=>{
   companyTotals.innerHTML+=`${c}: ‚Çπ${companySum[c].toLocaleString()}<br>`;
 });
}

function exportPDF(){
 html2pdf().from(document.body)
 .set({filename:"Ayyappan_Report.pdf",jsPDF:{orientation:"landscape"}}).save();
}
function toggleDark(){document.body.classList.toggle("dark")}
</script>
</body>
</html>
