// Function to toggle the new Work History Modal
function toggleWorkHistory() {
    const m = document.getElementById('workHistoryModal');
    const isOpen = m.style.display === 'flex';
    m.style.display = isOpen ? 'none' : 'flex';
    if (!isOpen) generateWorkHistoryReport();
}

// Function to generate the detailed site-by-site report
function generateWorkHistoryReport() {
    const fMonth = document.getElementById('filterMonth').value;
    const tbody = document.getElementById('workHistoryTableBody');
    const tfoot = document.getElementById('workHistoryTableFoot');
    tbody.innerHTML = "";
    
    let grandGross = 0;
    let grandWages = 0;
    let grandNet = 0;

    // Filter based on the month selected in the main footer
    const filtered = allEntries.filter(d => {
        if (d.isHoliday) return false;
        if (fMonth !== 'all' && new Date(d.date).getMonth() != fMonth) return false;
        return true;
    });

    filtered.forEach(d => {
        let siteWages = 0;
        d.logs?.forEach(l => {
            siteWages += (parseFloat(l.sal) || 0) + (parseFloat(l.ot) || 0) + (parseFloat(l.pet) || 0) + (parseFloat(l.food) || 0);
        });

        const gross = parseFloat(d.total) || 0;
        const net = gross - siteWages;
        const days = d.logs?.length || 1;

        grandGross += gross;
        grandWages += siteWages;
        grandNet += net;

        tbody.innerHTML += `
            <tr class="border-b border-white/5 hover:bg-white/5">
                <td class="p-2 font-bold">${d.customer}<br><span class="text-[9px] text-gray-500">${d.date}</span></td>
                <td class="p-2 text-center">${days}</td>
                <td class="p-2 text-right">₹${gross.toLocaleString()}</td>
                <td class="p-2 text-right text-red-400">₹${siteWages.toLocaleString()}</td>
                <td class="p-2 text-right text-green-400">₹${net.toLocaleString()}</td>
            </tr>
        `;
    });

    tfoot.innerHTML = `
        <tr>
            <td class="p-2">TOTALS</td>
            <td class="p-2 text-center">-</td>
            <td class="p-2 text-right text-blue-400">₹${grandGross.toLocaleString()}</td>
            <td class="p-2 text-right text-red-500">₹${grandWages.toLocaleString()}</td>
            <td class="p-2 text-right text-yellow-400">₹${grandNet.toLocaleString()}</td>
        </tr>
    `;
}
