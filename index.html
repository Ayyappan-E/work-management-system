<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayyappan Manager | Cloud Edition</title>
    <!-- Tailwind & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            min-height: 100vh;
            color: #f1f5f9;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .input-field {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    </style>
</head>
<body>

    <div id="app" class="max-w-4xl mx-auto p-4 pb-24">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 pt-4">
            <div>
                <h1 class="text-2xl font-black bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-emerald-400">
                    AYYAPPAN MANAGER
                </h1>
                <p class="text-[10px] text-slate-400 tracking-widest uppercase" id="user-display">Initializing...</p>
            </div>
            <div class="flex gap-2">
                <button id="sync-indicator" class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-800 text-xs">
                    <i class="fas fa-cloud text-slate-500"></i>
                </button>
                <button onclick="window.location.reload()" class="w-8 h-8 rounded-full flex items-center justify-center bg-slate-800 hover:bg-slate-700 transition-colors">
                    <i class="fas fa-sync-alt text-slate-300"></i>
                </button>
            </div>
        </header>

        <!-- Main Stats Card -->
        <div class="glass-card rounded-3xl p-6 mb-6">
            <div class="grid grid-cols-2 gap-4 mb-6" id="monthlyBreakdownGrid">
                <!-- Dynamic Content -->
                <div class="animate-pulse bg-slate-700/50 h-20 rounded-2xl"></div>
                <div class="animate-pulse bg-slate-700/50 h-20 rounded-2xl"></div>
            </div>

            <div class="flex flex-wrap gap-2 items-center">
                <select id="filterMonth" class="input-field rounded-lg px-3 py-2 text-sm">
                    <option value="0">January</option><option value="1">February</option>
                    <option value="2">March</option><option value="3">April</option>
                    <option value="4">May</option><option value="5">June</option>
                    <option value="6">July</option><option value="7">August</option>
                    <option value="8">September</option><option value="9">October</option>
                    <option value="10">November</option><option value="11">December</option>
                </select>
                <select id="filterYear" class="input-field rounded-lg px-3 py-2 text-sm">
                    <option value="2024">2024</option>
                    <option value="2025">2025</option>
                    <option value="2026">2026</option>
                </select>
                <div class="ml-auto flex gap-2">
                    <button onclick="downloadPDF()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> PDF
                    </button>
                    <button onclick="shareWhatsApp()" class="bg-green-600 hover:bg-green-500 text-white px-3 py-2 rounded-lg text-sm font-bold flex items-center gap-2">
                        <i class="fab fa-whatsapp"></i> Share
                    </button>
                </div>
            </div>
        </div>

        <!-- Add Entry Form -->
        <div class="glass-card rounded-3xl p-6 mb-6">
            <h3 class="text-sm font-bold text-slate-300 mb-4 uppercase tracking-tighter">Add New Entry</h3>
            <form id="entryForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 ml-1">WORK TYPE</label>
                    <select id="workType" class="input-field w-full rounded-xl p-3">
                        <option value="Solo">Solo Work</option>
                        <option value="Partner">Partner Work</option>
                    </select>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 ml-1">DATE</label>
                    <input type="date" id="date" class="input-field w-full rounded-xl p-3">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 ml-1">LOCATION / WORK NAME</label>
                    <input type="text" id="location" placeholder="e.g. Apartment A" class="input-field w-full rounded-xl p-3" required>
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] text-slate-500 ml-1">SQFT AREA</label>
                    <input type="number" id="sqft" placeholder="0" class="input-field w-full rounded-xl p-3" required>
                </div>
                <button type="submit" class="md:col-span-2 bg-blue-600 hover:bg-blue-500 text-white font-black py-4 rounded-2xl shadow-lg shadow-blue-500/20 transition-all active:scale-95">
                    SAVE WORK ENTRY
                </button>
            </form>
        </div>

        <!-- Log List -->
        <div id="logList" class="space-y-3">
            <!-- Entries will appear here -->
        </div>

        <!-- Global Totals (Sticky Bottom) -->
        <div class="fixed bottom-0 left-0 right-0 p-4 max-w-4xl mx-auto">
            <div class="glass-card rounded-2xl p-4 shadow-2xl border-t border-blue-500/30 flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-[9px] text-slate-400 uppercase">Grand Total (This Month)</span>
                    <span id="tblGrandTotal" class="text-2xl font-black text-blue-400">â‚¹0</span>
                </div>
                <div class="flex gap-4 text-right">
                    <div>
                        <div class="text-[9px] text-slate-400 uppercase">Solo</div>
                        <div id="tblSolo" class="font-bold text-sm">â‚¹0</div>
                    </div>
                    <div>
                        <div class="text-[9px] text-slate-400 uppercase">Partner (My Share)</div>
                        <div id="tblPartnerMine" class="font-bold text-sm">â‚¹0</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, setDoc, deleteDoc, onSnapshot, query, where, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIG & INIT ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ayyappan-manager';

        let currentUser = null;
        let entries = [];
        let rates = { solo: 12, partner: 12 }; // Default rates

        // --- AUTH LOGIC (Rule 3) ---
        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
            }
        };

        initAuth();

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('user-display').innerText = `Logged in: ${user.uid}`;
                setupListeners();
            }
        });

        // --- DATA SYNC (Rule 1 & 2) ---
        function setupListeners() {
            if (!currentUser) return;

            // Sync User Settings (Rates)
            const settingsDoc = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'general');
            onSnapshot(settingsDoc, (snapshot) => {
                if (snapshot.exists()) {
                    rates = snapshot.data();
                } else {
                    setDoc(settingsDoc, rates);
                }
            }, (err) => console.error("Settings error:", err));

            // Sync Work Entries (Private Collection)
            const entriesCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'workEntries');
            onSnapshot(entriesCol, (snapshot) => {
                entries = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                updateUI();
                updateSyncStatus('synced');
            }, (err) => {
                console.error("Entries error:", err);
                updateSyncStatus('error');
            });
        }

        // --- APP LOGIC ---
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        document.getElementById('entryForm').onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const entry = {
                type: document.getElementById('workType').value,
                date: document.getElementById('date').value,
                location: document.getElementById('location').value,
                sqft: parseFloat(document.getElementById('sqft').value),
                timestamp: Timestamp.now()
            };

            updateSyncStatus('pending');
            try {
                const entriesCol = collection(db, 'artifacts', appId, 'users', currentUser.uid, 'workEntries');
                await addDoc(entriesCol, entry);
                e.target.reset();
                document.getElementById('date').valueAsDate = new Date();
            } catch (err) {
                console.error("Save error:", err);
                updateSyncStatus('error');
            }
        };

        window.deleteEntry = async (id) => {
            if (!currentUser || !confirm("Delete this entry?")) return;
            try {
                await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'workEntries', id));
            } catch (err) {
                console.error("Delete error:", err);
            }
        };

        function getFilteredEntries() {
            const filterM = parseInt(document.getElementById('filterMonth').value);
            const filterY = parseInt(document.getElementById('filterYear').value);

            return entries.filter(e => {
                const d = new Date(e.date);
                return d.getMonth() === filterM && d.getFullYear() === filterY;
            }).sort((a,b) => new Date(b.date) - new Date(a.date));
        }

        function updateUI() {
            const filtered = getFilteredEntries();

            // Calculate Totals
            let soloTotal = 0;
            let partnerTotal = 0;
            let totalSqft = 0;

            const logList = document.getElementById('logList');
            logList.innerHTML = '';

            filtered.forEach(item => {
                const earning = item.type === 'Solo' ? item.sqft * rates.solo : (item.sqft * rates.partner) / 2;
                if (item.type === 'Solo') soloTotal += earning;
                else partnerTotal += earning;
                totalSqft += item.sqft;

                const card = document.createElement('div');
                card.className = 'glass-card p-4 rounded-2xl flex justify-between items-center group animate-in fade-in slide-in-from-bottom-2';
                card.innerHTML = `
                    <div class="flex gap-4 items-center">
                        <div class="w-10 h-10 rounded-xl ${item.type === 'Solo' ? 'bg-blue-500/20 text-blue-400' : 'bg-purple-500/20 text-purple-400'} flex items-center justify-center font-bold text-xs">
                            ${item.type[0]}
                        </div>
                        <div>
                            <div class="font-bold text-sm">${item.location}</div>
                            <div class="text-[10px] text-slate-500">${new Date(item.date).toLocaleDateString()} â€¢ ${item.sqft} sqft</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <div class="font-black text-slate-200">â‚¹${Math.round(earning).toLocaleString()}</div>
                            <div class="text-[9px] text-slate-500 uppercase">${item.type}</div>
                        </div>
                        <button onclick="deleteEntry('${item.id}')" class="text-slate-600 hover:text-red-400 transition-colors p-2">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                `;
                logList.appendChild(card);
            });

            // Update Summaries
            const grand = soloTotal + partnerTotal;
            document.getElementById('tblSolo').innerText = `â‚¹${Math.round(soloTotal).toLocaleString()}`;
            document.getElementById('tblPartnerMine').innerText = `â‚¹${Math.round(partnerTotal).toLocaleString()}`;
            document.getElementById('tblGrandTotal').innerText = `â‚¹${Math.round(grand).toLocaleString()}`;

            document.getElementById('monthlyBreakdownGrid').innerHTML = `
                <div class="bg-blue-600/10 p-4 rounded-2xl border border-blue-500/20">
                    <div class="text-[9px] opacity-50 uppercase font-bold tracking-wider">Estimated Profit</div>
                    <div class="text-2xl font-black text-blue-400">â‚¹${Math.round(grand).toLocaleString()}</div>
                </div>
                <div class="bg-emerald-600/10 p-4 rounded-2xl border border-emerald-500/20">
                    <div class="text-[9px] opacity-50 uppercase font-bold tracking-wider">Total Sqft</div>
                    <div class="text-2xl font-black text-emerald-400">${totalSqft.toLocaleString()}</div>
                </div>
            `;
        }

        function updateSyncStatus(status) {
            const icon = document.querySelector('#sync-indicator i');
            icon.className = 'fas ' + (status === 'synced' ? 'fa-cloud text-emerald-400' : 
                                      status === 'pending' ? 'fa-circle-notch fa-spin text-blue-400' : 
                                      'fa-exclamation-triangle text-red-400');
        }

        // Global Handlers
        window.shareWhatsApp = () => {
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            const total = document.getElementById('tblGrandTotal').innerText;
            const msg = `*ðŸ“Š Work Report: ${monthNames[fM]} ${fY}*\nTotal Earnings: ${total}\nShared from Ayyappan Manager Pro.`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.downloadPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            const filtered = getFilteredEntries();

            // Header
            doc.setFontSize(22);
            doc.setTextColor(40);
            doc.text('AYYAPPAN MANAGER REPORT', 14, 22);
            
            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text(`Period: ${monthNames[fM]} ${fY}`, 14, 32);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 38);

            // Table Data
            const tableData = filtered.map(item => [
                new Date(item.date).toLocaleDateString(),
                item.location,
                item.type,
                item.sqft,
                `Rs. ${Math.round(item.type === 'Solo' ? item.sqft * rates.solo : (item.sqft * rates.partner) / 2).toLocaleString()}`
            ]);

            doc.autoTable({
                startY: 45,
                head: [['Date', 'Location', 'Type', 'Sqft', 'Earning']],
                body: tableData,
                headStyles: { fillStyle: 'f', fillColor: [59, 130, 246] },
                alternateRowStyles: { fillColor: [245, 247, 250] }
            });

            // Summary Footer
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(14);
            doc.setTextColor(40);
            doc.text(`Total Solo Earning: ${document.getElementById('tblSolo').innerText}`, 14, finalY);
            doc.text(`Total Partner Share: ${document.getElementById('tblPartnerMine').innerText}`, 14, finalY + 7);
            doc.setFont(undefined, 'bold');
            doc.text(`GRAND TOTAL: ${document.getElementById('tblGrandTotal').innerText}`, 14, finalY + 16);

            doc.save(`Work_Report_${monthNames[fM]}_${fY}.pdf`);
        };

        // Init Form
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('filterMonth').value = new Date().getMonth();
        document.getElementById('filterYear').value = new Date().getFullYear();
        document.getElementById('filterMonth').onchange = updateUI;
        document.getElementById('filterYear').onchange = updateUI;

    </script>
</body>
</html>
