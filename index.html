<div class="flex gap-2 mb-4">
    <div class="flex-1">
        <label>Filter Month</label>
        <select id="filterMonth" onchange="switchFilter()" class="input-box bg-slate-800 border-none font-bold text-blue-400">
            <option value="all">All Months</option>
            <option value="0">January</option>
            <option value="1">February</option>
            <option value="2">March</option>
            <option value="3">April</option>
            <option value="4">May</option>
            <option value="5">June</option>
            <option value="6">July</option>
            <option value="7">August</option>
            <option value="8">September</option>
            <option value="9">October</option>
            <option value="10">November</option>
            <option value="11">December</option>
        </select>
    </div>
    <div class="w-1/3">
        <label>Year</label>
        <select id="filterYear" onchange="switchFilter()" class="input-box bg-slate-800 border-none font-bold text-blue-400">
            <script>
                const curYear = new Date().getFullYear();
                for(let y = curYear; y >= 2023; y--) {
                    document.write(`<option value="${y}">${y}</option>`);
                }
            </script>
        </select>
    </div>
</div>

<script>
    // Update the switchMonth function and add switchFilter in the script section:

    function switchFilter() {
        applyFilters();
        const m = document.getElementById('filterMonth').value;
        const y = document.getElementById('filterYear').value;
        const mName = m === 'all' ? 'All' : months[m];
        document.getElementById('historyLabel').innerText = `History: ${mName} ${y}`;
    }

    // Update the applyFilters function logic to check for BOTH month and year:
    function applyFilters() {
        let yearEarned = 0, soloEarn = 0, partnerEarn = 0;
        const container = document.getElementById('displayArea'); 
        container.innerHTML = "";
        
        const selMonth = document.getElementById('filterMonth').value;
        const selYear = document.getElementById('filterYear').value;

        allEntries.forEach(d => {
            const entryDate = new Date(d.date);
            const entryMonth = entryDate.getMonth();
            const entryYear = entryDate.getFullYear();

            let siteExp = 0, helpers = [];
            d.logs?.forEach(l => { 
                siteExp += (parseFloat(l.sal)||0) + (parseFloat(l.ot)||0) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0); 
                if(!helpers.includes(l.helper)) helpers.push(l.helper); 
            });

            const net = (parseFloat(d.total)||0) - siteExp;
            
            // Still track yearly target based on the selected year dropdown
            if(!d.isHoliday && entryYear == selYear) {
                yearEarned += (d.projectType === 'Partner' ? net/2 : net);
            }

            // Apply strict Month & Year Filter for the display area
            const monthMatch = (selMonth === 'all' || entryMonth == selMonth);
            const yearMatch = (entryYear == selYear);

            if(!monthMatch || !yearMatch) return;

            if(!d.isHoliday) { 
                if(d.projectType === 'Partner') partnerEarn += (net/2); else soloEarn += net; 
            }
            
            container.innerHTML += `<div class="glass p-5 border-l-4 ${d.isHoliday ? 'border-red-500':'border-blue-600'} shadow-lg mb-4">
                <div class="flex justify-between items-start">
                    <div onclick="editDoc('${d.id}')" class="flex-1 cursor-pointer">
                        <div class="text-[10px] text-gray-400 font-bold mb-1 uppercase">${d.date} | ${d.projectType}</div>
                        <h4 class="font-black text-base uppercase text-white mb-1">${d.isHoliday ? 'Holiday' : d.customer}</h4>
                        <div class="text-[11px] text-gray-400 mb-2">${d.location || 'N/A'}</div>
                        ${!d.isHoliday ? `<div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-white/10"><div class="card-detail">Team: <span class="card-highlight">${helpers.join(', ') || 'Self'}</span></div><div class="card-detail text-right">Wages: <span class="text-red-400 font-bold">₹${Math.round(siteExp)}</span></div></div>` : ''}
                        <div class="work-note-box">${d.comment || ''}</div>
                    </div>
                    <div class="flex flex-col gap-4 ml-3">
                        <button onclick="editDoc('${d.id}')" class="text-blue-400"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="deleteDoc('${d.id}')" class="text-red-500"><i class="fas fa-trash-alt"></i></button>
                    </div>
                </div>
            </div>`;
        });

        document.getElementById('tblSolo').innerText = "₹" + Math.round(soloEarn).toLocaleString();
        document.getElementById('tblPartnerMine').innerText = "₹" + Math.round(partnerEarn).toLocaleString();
        document.getElementById('tblGrandTotal').innerText = "₹" + Math.round(soloEarn + partnerEarn).toLocaleString();
        updateTargetUI(yearEarned);
    }

    // Update window.onload to set default dropdown values
    window.onload = async () => { 
        document.getElementById('date').valueAsDate = new Date(); 
        const now = new Date();
        document.getElementById('filterMonth').value = now.getMonth();
        document.getElementById('filterYear').value = now.getFullYear();
        await syncSettings(); 
        addDayRow(); 
        applyFilters(); 
    };
</script>
