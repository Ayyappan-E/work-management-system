<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayyappan Manager | Pro Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); color: #f1f5f9; min-height: 100vh; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 1rem; }
        .input-box { background: rgba(0,0,0,0.4); border: 1px solid #475569; border-radius: 0.6rem; padding: 0.7rem; color: white; width: 100%; outline: none; font-size: 14px; }
        label { font-size: 11px; font-weight: 800; color: #cbd5e1; text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
        
        /* Auth Screen */
        #authOverlay { position: fixed; inset: 0; z-index: 9999; background: #0f172a; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #3b82f6; transition: all 0.2s; }
        .pin-dot.filled { background: #3b82f6; transform: scale(1.2); box-shadow: 0 0 10px #3b82f6; }
        .num-btn { width: 65px; height: 65px; border-radius: 50%; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); font-size: 1.5rem; font-weight: bold; }
        .num-btn:active { background: #3b82f6; }
    </style>
</head>
<body class="p-4 pb-96">

    <div id="authOverlay">
        <div class="text-center w-full max-w-xs p-8 glass border-blue-500/30">
            <i class="fas fa-shield-halved text-4xl text-blue-500 mb-4"></i>
            <h2 class="text-xl font-black uppercase mb-6 tracking-widest">Security Check</h2>
            
            <div class="flex justify-center gap-4 mb-10" id="pinDisplay">
                <div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div><div class="pin-dot"></div>
            </div>

            <div class="grid grid-cols-3 gap-4 mb-6 justify-items-center">
                <button onclick="pressPin(1)" class="num-btn">1</button>
                <button onclick="pressPin(2)" class="num-btn">2</button>
                <button onclick="pressPin(3)" class="num-btn">3</button>
                <button onclick="pressPin(4)" class="num-btn">4</button>
                <button onclick="pressPin(5)" class="num-btn">5</button>
                <button onclick="pressPin(6)" class="num-btn">6</button>
                <button onclick="pressPin(7)" class="num-btn">7</button>
                <button onclick="pressPin(8)" class="num-btn">8</button>
                <button onclick="pressPin(9)" class="num-btn">9</button>
                <button onclick="tryBiometric()" id="bioBtn" class="num-btn text-blue-400 opacity-20"><i class="fas fa-fingerprint"></i></button>
                <button onclick="pressPin(0)" class="num-btn">0</button>
                <button onclick="clearPin()" class="num-btn text-red-400"><i class="fas fa-backspace"></i></button>
            </div>
            <p id="authMsg" class="text-[10px] text-gray-500 uppercase font-bold">Session Locked</p>
        </div>
    </div>

    <div id="mainApp" class="hidden opacity-0 transition-opacity duration-500">
        <div class="max-w-md mx-auto">
            <div class="flex justify-between items-center mb-6">
                <h1 class="font-black text-2xl italic uppercase tracking-tighter">Ayyappan <span class="text-blue-500">Pro</span></h1>
                <div class="flex gap-3">
                    <button onclick="logout()" class="w-10 h-10 glass flex items-center justify-center text-red-400"><i class="fas fa-power-off"></i></button>
                    <button onclick="toggleSettings()" class="w-10 h-10 glass flex items-center justify-center text-blue-400"><i class="fas fa-cog"></i></button>
                </div>
            </div>

            <div id="settingsModal" class="modal">
                <div class="glass p-6 w-full max-w-sm space-y-4">
                    <h2 class="text-lg font-bold text-blue-400 uppercase text-center border-b border-white/10 pb-2">Cloud Configuration</h2>
                    
                    <div class="bg-blue-600/10 p-3 rounded-lg border border-blue-500/20">
                        <label class="text-blue-400">Device Biometrics</label>
                        <button id="regBioBtn" onclick="registerBiometric()" class="w-full bg-blue-600/20 hover:bg-blue-600/40 py-2 rounded-lg text-[10px] font-bold uppercase border border-blue-500/50">
                            <i class="fas fa-fingerprint mr-2"></i> Register Fingerprint
                        </button>
                    </div>

                    <div class="bg-white/5 p-3 rounded-lg">
                        <label>App MPIN</label>
                        <input type="password" id="setMpin" maxlength="4" class="input-box text-center tracking-[1rem]">
                    </div>
                    
                    <button onclick="saveSettings()" class="w-full bg-blue-600 py-3 rounded-lg font-bold uppercase">Save & Sync</button>
                    <button onclick="toggleSettings()" class="w-full text-xs text-gray-500">Close</button>
                </div>
            </div>

            <p class="text-center text-gray-500 mt-20">App Content Loaded</p>
        </div>
    </div>

    <script>
        // --- CONFIG & GLOBALS ---
        const firebaseConfig = { apiKey: "AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58", authDomain: "ayyappan-work-management.firebaseapp.com", projectId: "ayyappan-work-management" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let globalSettings = { mpin: "0000", bioEnabled: false };
        let currentPinInput = "";
        const SESSION_KEY = "ayyappan_active_session";

        // --- AUTH & SESSION LOGIC ---
        
        async function initAuth() {
            // 1. Fetch Cloud Settings
            const doc = await db.collection("appSettings").doc("userConfig").get();
            if(doc.exists) globalSettings = doc.data();

            // 2. Check for Active Session (Persistence on Refresh)
            if (sessionStorage.getItem(SESSION_KEY) === "true") {
                unlockApp();
            } else {
                // 3. If no session, check if Biometrics is possible
                if (localStorage.getItem('device_bio_linked')) {
                    document.getElementById('bioBtn').classList.remove('opacity-20');
                    setTimeout(tryBiometric, 500); 
                }
            }
        }

        function pressPin(n) {
            if (currentPinInput.length < 4) {
                currentPinInput += n;
                updatePinDots();
                if (currentPinInput.length === 4) {
                    if (currentPinInput === globalSettings.mpin) {
                        sessionStorage.setItem(SESSION_KEY, "true");
                        unlockApp();
                    } else {
                        shakePin();
                        currentPinInput = "";
                        setTimeout(updatePinDots, 500);
                    }
                }
            }
        }

        function updatePinDots() {
            const dots = document.querySelectorAll('.pin-dot');
            dots.forEach((dot, i) => dot.classList.toggle('filled', i < currentPinInput.length));
        }

        function unlockApp() {
            document.getElementById('authOverlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('authOverlay').style.display = 'none';
                document.getElementById('mainApp').classList.remove('hidden');
                document.getElementById('mainApp').classList.add('opacity-100');
            }, 500);
        }

        function logout() {
            sessionStorage.removeItem(SESSION_KEY);
            location.reload();
        }

        // --- BIOMETRIC SYNC LOGIC ---

        async function registerBiometric() {
            try {
                const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
                const options = {
                    publicKey: {
                        challenge,
                        rp: { name: "Ayyappan Pro" },
                        user: { id: new Uint8Array(16), name: "user", displayName: "Ayyappan" },
                        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
                        authenticatorSelection: { userVerification: "required", authenticatorAttachment: "platform" },
                        timeout: 60000
                    }
                };
                const cred = await navigator.credentials.create(options);
                if (cred) {
                    await db.collection("appSettings").doc("userConfig").update({ bioEnabled: true });
                    localStorage.setItem('device_bio_linked', 'true');
                    alert("Fingerprint linked to Cloud!");
                    document.getElementById('bioBtn').classList.remove('opacity-20');
                }
            } catch (e) { alert("Registration Failed: " + e.message); }
        }

        async function tryBiometric() {
            if (!localStorage.getItem('device_bio_linked')) return;
            try {
                const challenge = new Uint8Array(32); window.crypto.getRandomValues(challenge);
                const assertion = await navigator.credentials.get({
                    publicKey: { challenge, timeout: 60000, userVerification: "required" }
                });
                if (assertion) {
                    sessionStorage.setItem(SESSION_KEY, "true");
                    unlockApp();
                }
            } catch (e) { console.log("Bio Auth Bypassed"); }
        }

        // UI Helpers
        function toggleSettings() {
            const m = document.getElementById('settingsModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
            document.getElementById('setMpin').value = globalSettings.mpin;
        }

        async function saveSettings() {
            globalSettings.mpin = document.getElementById('setMpin').value;
            await db.collection("appSettings").doc("userConfig").set(globalSettings);
            alert("Settings Synced!");
            toggleSettings();
        }

        function clearPin() { currentPinInput = currentPinInput.slice(0, -1); updatePinDots(); }
        
        function shakePin() {
            document.getElementById('authMsg').innerText = "Incorrect MPIN";
            document.getElementById('authMsg').style.color = "#ef4444";
        }

        window.onload = initAuth;
    </script>
</body>
</html>
