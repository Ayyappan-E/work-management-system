<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ayyappan Manager | Pro Master</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            --text-main: #f1f5f9;
            --text-dim: #94a3b8;
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --input-bg: rgba(0,0,0,0.4);
            --card-bg: rgba(255, 255, 255, 0.03);
            --footer-bg: rgba(15, 23, 42, 0.8);
            --watermark-color: rgba(255, 255, 255, 0.03);
        }

        .light-mode {
            --bg-gradient: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            --text-main: #1e293b;
            --text-dim: #64748b;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.1);
            --input-bg: rgba(255, 255, 255, 0.9);
            --card-bg: rgba(0, 0, 0, 0.02);
            --footer-bg: rgba(241, 245, 249, 0.9);
            --watermark-color: rgba(0, 0, 0, 0.02);
        }

        body { 
            background: var(--bg-gradient); 
            color: var(--text-main); 
            min-height: 100vh; 
            font-family: 'Inter', sans-serif; 
            transition: background 0.3s ease, color 0.3s ease;
            position: relative;
        }

        /* Watermark Styles */
        body::before {
            content: "AYYAPPAN PRO";
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-30deg);
            font-size: 8vw;
            font-weight: 900;
            color: var(--watermark-color);
            z-index: -1;
            pointer-events: none;
            white-space: nowrap;
            letter-spacing: 0.5rem;
        }

        .glass { 
            background: var(--glass-bg); 
            backdrop-filter: blur(12px); 
            border: 1px solid var(--glass-border); 
            border-radius: 1rem; 
        }

        .input-box { 
            background: var(--input-bg); 
            border: 1px solid #475569; 
            border-radius: 0.6rem; 
            padding: 0.7rem; 
            color: inherit; 
            width: 100%; 
            outline: none; 
            font-size: 14px; 
        }

        label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 4px; display: block; letter-spacing: 0.5px; }
        
        .day-entry { 
            background: var(--card-bg); 
            border: 1px solid var(--glass-border); 
            padding: 12px; 
            border-radius: 12px; 
            margin-bottom: 10px; 
            position: relative; 
        }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(4px); }
        
        .summary-section { 
            margin-top: 2rem;
            background: var(--footer-bg); 
            border-top: 3px solid #3b82f6; 
            padding: 20px 12px; 
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        .excel-table-container {
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            max-height: 500px;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .excel-table-container.collapsed {
            max-height: 0;
            margin-bottom: 0;
            border: 0;
            opacity: 0;
            pointer-events: none;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10.5px;
            white-space: nowrap;
        }
        .excel-table th {
            position: sticky;
            top: 0;
            background: #1e1b4b;
            padding: 12px 10px;
            text-align: left;
            text-transform: uppercase;
            color: var(--text-dim);
            border-bottom: 2px solid var(--glass-border);
            font-weight: 800;
            z-index: 10;
        }
        .light-mode .excel-table th { background: #e2e8f0; }
        .excel-table td {
            padding: 10px;
            border-bottom: 1px solid var(--glass-border);
        }
        .excel-table tr:hover { background: rgba(255,255,255,0.05); }

        .toggle-switch { position: relative; display: inline-block; width: 34px; height: 20px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.1); transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #3b82f6; }
        input:checked + .slider:before { transform: translateX(14px); }

        .status-badge { padding: 2px 6px; border-radius: 4px; font-size: 8px; font-weight: 900; text-transform: uppercase; }
        .status-received { background: #059669; color: white; }
        .status-pending { background: #dc2626; color: white; }
        .status-unknown { background: #4b5563; color: white; }

        #msgBox { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 200; min-width: 250px; text-align: center; border-radius: 12px; padding: 12px 24px; font-weight: bold; }
        
        .kural-card {
            border-left: 4px solid #f59e0b;
            background: linear-gradient(to right, rgba(245, 158, 11, 0.1), transparent);
        }

        /* Insight Bar Animation */
        .insight-bar { height: 6px; border-radius: 3px; transition: width 1s ease-out; }
    </style>
</head>
<body class="p-4">

    <div id="msgBox" class="bg-blue-600 text-white shadow-2xl"></div>

    <div class="max-w-4xl mx-auto">
        <!-- Daily Thirukkural Section -->
        <div id="kuralSection" class="glass kural-card p-4 mb-6 hidden">
            <div class="flex items-center gap-2 mb-2">
                <span class="bg-yellow-500 text-black text-[9px] font-black px-2 py-0.5 rounded uppercase">Daily Thirukkural</span>
                <span id="kuralNumber" class="text-[10px] font-bold opacity-60">Loading...</span>
            </div>
            <p id="kuralTamil" class="text-sm font-bold mb-2 leading-relaxed text-yellow-500"></p>
            <p id="kuralMeaning" class="text-xs italic opacity-80 leading-snug"></p>
        </div>

        <div class="flex justify-between items-center mb-6">
            <h1 class="font-black text-2xl italic uppercase tracking-tighter text-blue-500">Ayyappan Pro <span class="text-white/40 font-normal text-xs not-italic lowercase">manager</span></h1>
            <div class="flex gap-3">
                <button id="themeToggle" onclick="toggleTheme()" class="w-10 h-10 glass flex items-center justify-center text-yellow-400 shadow-lg"><i class="fas fa-moon"></i></button>
                <button onclick="toggleSettings()" class="w-10 h-10 glass flex items-center justify-center text-blue-400 shadow-lg"><i class="fas fa-cog"></i></button>
            </div>
        </div>

        <!-- Target UI -->
        <div class="glass p-4 mb-6 border-l-4 border-yellow-500 shadow-lg max-w-md mx-auto">
            <div class="flex justify-between items-end mb-2">
                <label id="targetLabel" class="m-0 text-yellow-500 font-black">Target Progress</label>
                <span id="targetRem" class="text-xs font-bold">â‚¹0</span>
            </div>
            <div class="w-full bg-black/10 h-3 rounded-full mb-2"><div id="targetBar" class="bg-yellow-500 h-full rounded-full transition-all duration-700" style="width:0%"></div></div>
            <div class="flex justify-between text-[10px] font-bold opacity-70"><span id="targetEarned">Earned: â‚¹0</span><span id="targetGoal">Target: â‚¹0</span></div>
        </div>

        <!-- Entry Form -->
        <div class="glass p-5 mb-8 space-y-5 border-t-4 border-blue-600 shadow-2xl max-w-md mx-auto">
            <input type="hidden" id="editId">
            <div class="grid grid-cols-2 gap-4">
                <div><label>Work Date</label><input type="date" id="date" class="input-box"></div>
                <div><label>Quotation No</label><input type="text" id="qn" class="input-box" placeholder="QN-XXXX"></div>
            </div>
            <div class="grid grid-cols-2 gap-3 bg-black/10 p-3 rounded-xl border border-white/10">
                <div class="flex items-center gap-2"><input type="checkbox" id="isHoliday" onchange="checkHoliday()" class="w-5 h-5 accent-red-500"><label class="m-0 text-red-500">Holiday</label></div>
                <select id="projectType" class="bg-transparent text-xs font-black text-blue-500 uppercase outline-none"><option value="Solo">Solo Work</option><option value="Partner">Partner Work</option></select>
            </div>
            
            <div id="workFields" class="space-y-5">
                <div><label>Company</label><select id="company" class="input-box"></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label>Customer Name *</label><input type="text" id="customer" class="input-box"></div>
                    <div><label>Site Location</label><input type="text" id="location" class="input-box"></div>
                </div>

                <div id="helperGlobalWrapper" class="bg-blue-600/5 p-4 rounded-xl border border-white/10">
                    <div class="flex justify-between items-center mb-3">
                        <div class="flex items-center gap-2">
                            <label class="text-blue-500 m-0">Helper Logs</label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="helperSectionToggle" onchange="toggleHelperVisibility()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <button id="addHelperBtn" onclick="addDayRow()" class="hidden text-[10px] bg-blue-600 text-white px-3 py-1 rounded uppercase font-bold">+ Helper</button>
                    </div>
                    <div id="dayLogsContainer" class="hidden space-y-3"></div>
                </div>

                <div class="grid grid-cols-3 gap-3">
                    <div><label>Windows Qty</label><input type="number" id="windowQty" class="input-box" placeholder="Qty"></div>
                    <div><label>Total Sqft</label><input type="number" id="totalSqft" oninput="calculate()" class="input-box" placeholder="Sqft"></div>
                    <div><label>Rate / Sqft</label><input type="number" id="amtRate" oninput="calculate()" class="input-box" placeholder="Rate"></div>
                </div>

                <div class="flex justify-between items-center p-4 bg-black/5 rounded-2xl border border-white/10">
                    <div><label class="m-0 text-green-500">Gross Bill</label><div id="resTotal" class="text-xl font-black text-green-500">â‚¹0</div></div>
                    <div class="text-right"><label class="m-0 text-red-500">Total Wages</label><div id="resExpDisplay" class="text-lg font-bold text-red-500">â‚¹0</div></div>
                </div>
                <div><label>Work Description</label><textarea id="workNotes" class="input-box h-16"></textarea></div>
            </div>

            <div id="holidayReasonDiv" class="hidden"><label>Holiday Remark *</label><textarea id="holidayReason" class="input-box h-16"></textarea></div>

            <div class="p-3 bg-white/5 rounded-xl border border-white/10">
                <label>Payment Status</label>
                <div class="flex gap-2">
                    <button onclick="setPaymentStatus('Received')" id="btnReceived" class="flex-1 py-2 rounded-lg text-[10px] font-black uppercase border border-white/10 transition-all opacity-40">Received</button>
                    <button onclick="setPaymentStatus('Pending')" id="btnPending" class="flex-1 py-2 rounded-lg text-[10px] font-black uppercase border border-white/10 transition-all opacity-40">Pending</button>
                    <button onclick="setPaymentStatus('Unknown')" id="btnUnknown" class="flex-1 py-2 rounded-lg text-[10px] font-black uppercase border border-white/10 transition-all opacity-40">Unknown</button>
                    <input type="hidden" id="paymentStatus" value="Pending">
                </div>
            </div>
            
            <div class="grid grid-cols-3 gap-3">
                <button onclick="saveData()" class="col-span-2 bg-blue-600 text-white py-4 rounded-2xl font-black uppercase shadow-lg active:scale-95 transition-transform">Save Record</button>
                <button onclick="location.reload()" class="bg-slate-700 py-4 rounded-2xl font-bold text-white text-xs opacity-80">Reset</button>
            </div>
        </div>

        <!-- History Area -->
        <div class="flex justify-between items-center mb-4 px-1">
            <div class="flex items-baseline gap-2">
                <h3 id="historyTitle" class="text-sm font-black uppercase text-blue-500 tracking-wide">Site History</h3>
                <span id="historyMonthName" class="text-[10px] font-black text-white/40 uppercase">Selected Month</span>
            </div>
            <div class="flex items-center gap-3">
                <span id="recordCount" class="text-[9px] font-bold opacity-40 uppercase">Loading...</span>
                <button onclick="toggleHistory()" class="text-[10px] font-black uppercase text-blue-500 flex items-center gap-2 bg-blue-500/10 px-3 py-1.5 rounded-lg border border-blue-500/20 active:scale-95 transition-all">
                    <span id="historyToggleText">Minimize</span>
                    <i id="historyToggleIcon" class="fas fa-chevron-up"></i>
                </button>
            </div>
        </div>
        
        <div id="displayArea" class="excel-table-container">
            <table class="excel-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>QN</th>
                        <th>Company</th>
                        <th>Customer</th>
                        <th>Helpers</th>
                        <th>Qty</th>
                        <th>Type</th>
                        <th>Bill</th>
                        <th>Status</th>
                        <th>Net</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
        </div>

        <!-- Footer / Summary -->
        <div class="summary-section mt-8 max-w-md mx-auto">
            <div class="bg-black/20 rounded-2xl border border-white/10 overflow-hidden mb-4">
                <table class="w-full text-xs">
                    <tbody>
                        <tr class="border-b border-white/5"><td class="p-2 px-4 opacity-70">Solo Earnings</td><td id="tblSolo" class="p-2 text-right px-4 text-green-500 font-bold">â‚¹0</td></tr>
                        <tr class="border-b border-white/5"><td class="p-2 px-4 opacity-70">Partner Earnings</td><td id="tblPartnerMine" class="p-2 text-right px-4 text-blue-500 font-bold">â‚¹0</td></tr>
                        <tr class="bg-blue-600/10"><td class="p-3 px-4 font-black">TOTAL EARNED</td><td id="tblGrandTotal" class="p-3 text-right px-4 text-yellow-500 text-lg font-black">â‚¹0</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="grid grid-cols-2 gap-2 mb-4">
                <select id="filterMonth" onchange="applyFilters()" class="input-box py-2 text-[10px] font-bold uppercase"></select>
                <select id="filterYear" onchange="applyFilters()" class="input-box py-2 text-[10px] font-bold uppercase"></select>
            </div>

            <div class="grid grid-cols-1 gap-2">
                <button onclick="shareWhatsApp()" class="w-full bg-[#25D366] py-3 rounded-xl font-black text-white uppercase text-[10px] shadow-lg flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp text-lg"></i> Send WhatsApp Report
                </button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="exportHelperPDF()" class="w-full bg-emerald-600 py-3 rounded-xl font-black text-white uppercase text-[9px] shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-users"></i> Helper PDF
                    </button>
                    <button onclick="exportPartnerPDF()" class="w-full bg-blue-600 py-3 rounded-xl font-black text-white uppercase text-[9px] shadow-lg flex items-center justify-center gap-2">
                        <i class="fas fa-handshake"></i> Partner PDF
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="glass p-5 w-full max-w-sm max-h-[95vh] overflow-y-auto space-y-4">
            <div class="flex justify-between items-center border-b border-white/10 pb-2">
                <h2 class="text-sm font-black text-blue-400 uppercase tracking-widest">Global Settings</h2>
                <button onclick="toggleSettings()" class="text-gray-500"><i class="fas fa-times"></i></button>
            </div>
            <div class="bg-black/20 p-4 rounded-2xl border border-white/10">
                <div class="flex justify-between items-center mb-4"><label class="m-0 text-yellow-500 font-black">Annual Status</label><select id="reportYearSelect" onchange="generateTargetStatusReport()" class="bg-transparent text-xs font-bold text-blue-400 outline-none border border-white/10 rounded px-2 py-1"></select></div>
                <div id="annualSummaryCard" class="bg-blue-600/10 rounded-xl p-3 mb-4 flex justify-between items-center border border-blue-500/20">
                    <div><div class="text-[9px] uppercase opacity-60 font-bold">Annual Profit</div><div id="annualTotalVal" class="text-lg font-black text-blue-400">â‚¹0</div></div>
                    <div class="text-right"><div class="text-[9px] uppercase opacity-60 font-bold">Success Rate</div><div id="annualSuccessRate" class="text-lg font-black text-green-500">0%</div></div>
                </div>
                <div id="annualTargetReportList" class="space-y-4 max-h-64 overflow-y-auto pr-1"></div>
            </div>
            <div class="grid grid-cols-1 gap-3">
                <button onclick="toggleReport()" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 py-3 rounded-xl font-black text-white uppercase text-xs shadow-lg"><i class="fas fa-chart-pie mr-2"></i> View Performance</button>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="backupData()" class="bg-slate-700 py-2 rounded-xl font-bold text-white uppercase text-[10px] border border-white/10"><i class="fas fa-download mr-1"></i> Export</button>
                    <button onclick="document.getElementById('importFile').click()" class="bg-slate-700 py-2 rounded-xl font-bold text-white uppercase text-[10px] border border-white/10"><i class="fas fa-upload mr-1"></i> Import</button>
                    <input type="file" id="importFile" class="hidden" onchange="restoreData(event)">
                </div>
            </div>
            <div class="space-y-3 pt-2 border-t border-white/10">
                <div><label>Monthly Goal (â‚¹)</label><input type="number" id="setTarget" class="input-box" placeholder="Target per month"></div>
                <div><label>Registered Companies</label><textarea id="setCompanies" class="input-box h-12 text-xs"></textarea></div>
                <div><label>Helper Database</label><textarea id="setHelpers" class="input-box h-12 text-xs"></textarea></div>
            </div>
            <button id="saveSettingsBtn" onclick="saveSettings()" class="w-full bg-blue-600 py-4 rounded-2xl font-black text-white uppercase shadow-xl">Update & Sync</button>
        </div>
    </div>

    <!-- Smart Report Modal -->
    <div id="smartReportModal" class="modal">
        <div class="glass p-6 w-full max-w-md max-h-[90vh] overflow-y-auto space-y-6 shadow-2xl">
            <div class="flex justify-between items-center border-b border-white/10 pb-4">
                <div><h2 class="text-xl font-bold text-blue-400">Monthly Insights</h2><p id="insightSelectedLabel" class="text-[10px] font-bold text-white/50 uppercase tracking-widest mt-1"></p></div>
                <button onclick="toggleReport()" class="text-gray-500 p-2"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="monthlyBreakdownGrid" class="grid grid-cols-2 gap-3">
                <!-- Top Highlights will load here -->
            </div>

            <div id="monthlyPerformanceDetails" class="space-y-6">
                <!-- Performance List -->
            </div>

            <div class="pt-4">
                <button onclick="toggleReport()" class="w-full bg-slate-800 py-4 rounded-2xl font-black text-white uppercase text-xs tracking-widest border border-white/5">Close Analytics</button>
            </div>
        </div>
    </div>

    <script>
        const apiKey = ""; // Environment handles this
        const firebaseConfig = { apiKey: "AIzaSyCcdPfK_Y4sUb2O0jqT2-6O3iN1R2_jG58", authDomain: "ayyappan-work-management.firebaseapp.com", projectId: "ayyappan-work-management" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        let allEntries = [];
        let globalSettings = { target: 50000, companies: "Sharp, Buildcon", helpers: "Ravi, Kumar" };
        const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];

        async function fetchDailyKural() {
            try {
                const section = document.getElementById('kuralSection');
                section.classList.remove('hidden');
                
                const systemPrompt = "You are a Thirukkural provider. Return ONLY a JSON object with fields: 'number' (number), 'tamil' (the 2 lines in Tamil), 'meaning' (simple Tamil explanation). Pick a random one from the 1330 Kurals.";
                const userQuery = "Give me a random Thirukkural for today.";

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });

                if (!response.ok) throw new Error('API Error');
                
                const result = await response.json();
                const kural = JSON.parse(result.candidates[0].content.parts[0].text);
                
                document.getElementById('kuralNumber').innerText = `Kural ${kural.number}`;
                document.getElementById('kuralTamil').innerHTML = kural.tamil.replace(/\n/g, '<br>');
                document.getElementById('kuralMeaning').innerText = kural.meaning;
            } catch (error) {
                console.error("Kural generation failed", error);
                document.getElementById('kuralNumber').innerText = "Thirukkural Not Available";
            }
        }

        function showMessage(msg) {
            const box = document.getElementById('msgBox'); box.innerText = msg; box.style.display = 'block';
            setTimeout(() => { box.style.display = 'none'; }, 3000);
        }

        function setPaymentStatus(status) {
            document.getElementById('paymentStatus').value = status;
            ['Received', 'Pending', 'Unknown'].forEach(s => {
                const btn = document.getElementById(`btn${s}`);
                btn.classList.add('opacity-40');
                btn.style.backgroundColor = 'transparent';
                btn.style.color = 'inherit';
                if (s === status) {
                    btn.classList.remove('opacity-40');
                    if (s === 'Received') { btn.style.backgroundColor = '#059669'; btn.style.color = 'white'; }
                    if (s === 'Pending') { btn.style.backgroundColor = '#dc2626'; btn.style.color = 'white'; }
                    if (s === 'Unknown') { btn.style.backgroundColor = '#4b5563'; btn.style.color = 'white'; }
                }
            });
        }

        function toggleTheme() {
            const isLight = document.body.classList.toggle('light-mode');
            localStorage.setItem('theme', isLight ? 'light' : 'dark');
            document.querySelector('#themeToggle i').className = isLight ? 'fas fa-sun' : 'fas fa-moon';
        }

        function initTheme() {
            if (localStorage.getItem('theme') === 'light') {
                document.body.classList.add('light-mode');
                document.querySelector('#themeToggle i').className = 'fas fa-sun';
            }
        }

        function toggleHistory() {
            const area = document.getElementById('displayArea');
            const isCurrentlyCollapsed = area.classList.contains('collapsed');
            if (isCurrentlyCollapsed) {
                area.classList.remove('collapsed');
                document.getElementById('historyToggleText').innerText = 'Minimize';
                document.getElementById('historyToggleIcon').className = 'fas fa-chevron-up';
            } else {
                area.classList.add('collapsed');
                document.getElementById('historyToggleText').innerText = 'Maximize';
                document.getElementById('historyToggleIcon').className = 'fas fa-chevron-down';
            }
        }

        function toggleHelperVisibility() {
            const isChecked = document.getElementById('helperSectionToggle').checked;
            const container = document.getElementById('dayLogsContainer');
            const btn = document.getElementById('addHelperBtn');
            if (isChecked) {
                container.classList.remove('hidden'); btn.classList.remove('hidden');
                if(container.children.length === 0) addDayRow();
            } else {
                container.classList.add('hidden'); btn.classList.add('hidden');
            }
        }

        async function syncSettings() {
            const doc = await db.collection("appSettings").doc("userConfig").get();
            if(doc.exists) {
                globalSettings = doc.data();
                document.getElementById('setTarget').value = globalSettings.target || 50000;
                document.getElementById('setCompanies').value = globalSettings.companies;
                document.getElementById('setHelpers').value = globalSettings.helpers;
            }
            loadDropdowns();
            generateTargetStatusReport();
        }

        async function saveSettings() {
            const btn = document.getElementById('saveSettingsBtn'); btn.innerText = "Syncing...";
            globalSettings = { target: parseFloat(document.getElementById('setTarget').value) || 0, companies: document.getElementById('setCompanies').value, helpers: document.getElementById('setHelpers').value };
            await db.collection("appSettings").doc("userConfig").set(globalSettings);
            loadDropdowns(); btn.innerText = "Update & Sync"; toggleSettings(); applyFilters();
        }

        function loadDropdowns() {
            const comps = (globalSettings.companies || "").split(',');
            document.getElementById('company').innerHTML = comps.map(c => `<option>${c.trim()}</option>`).join('');
            const currentYear = new Date().getFullYear();
            ['filterYear', 'reportYearSelect', 'filterMonth'].forEach(id => {
                const el = document.getElementById(id);
                if(el && el.options.length === 0) {
                    if(id.includes('Year')) {
                        for(let y = currentYear; y >= 2024; y--) { el.add(new Option(y, y)); }
                    } else {
                        monthNames.forEach((m, i) => el.add(new Option(m, i)));
                    }
                }
            });
        }

        function addDayRow(data = null) {
            const container = document.getElementById('dayLogsContainer');
            const dayDiv = document.createElement('div'); dayDiv.className = "day-entry border-l-4 border-blue-500";
            dayDiv.innerHTML = `
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <input type="date" class="input-box h-8 py-0 d-hdate" value="${data?.hDate || document.getElementById('date').value}">
                    <select class="input-box h-8 py-0 d-helper"></select>
                </div>
                <div class="grid grid-cols-4 gap-1">
                    <div class="flex flex-col"><label class="text-[8px] mb-0 opacity-50 text-center">Sal</label><input type="number" class="input-box h-8 d-sal px-1 text-center" oninput="calculate()" value="${data?.sal || ''}"></div>
                    <div class="flex flex-col"><label class="text-[8px] mb-0 opacity-50 text-center">OT</label><input type="number" step="0.5" class="input-box h-8 d-ot px-1 text-center" oninput="calculate()" value="${data?.ot || ''}"></div>
                    <div class="flex flex-col"><label class="text-[8px] mb-0 opacity-50 text-center">Pet</label><input type="number" class="input-box h-8 d-pet px-1 text-center" oninput="calculate()" value="${data?.pet || ''}"></div>
                    <div class="flex flex-col"><label class="text-[8px] mb-0 opacity-50 text-center">Food</label><input type="number" class="input-box h-8 d-food px-1 text-center" oninput="calculate()" value="${data?.food || ''}"></div>
                </div>
                <button onclick="this.parentElement.remove(); calculate()" class="absolute -top-2 -right-2 bg-red-600 text-white w-5 h-5 rounded-full text-xs">Ã—</button>`;
            container.appendChild(dayDiv);
            const helps = (globalSettings.helpers || "").split(',');
            const sel = dayDiv.querySelector('.d-helper');
            sel.innerHTML = helps.map(h => `<option>${h.trim()}</option>`).join('');
            if(data) { sel.value = data.helper; calculate(); }
        }

        function calculate() {
            const val = (parseFloat(document.getElementById('totalSqft').value) || 0) * (parseFloat(document.getElementById('amtRate').value) || 0);
            let totalWages = 0; 
            document.querySelectorAll('.day-entry').forEach(row => { 
                const salVal = parseFloat(row.querySelector('.d-sal').value) || 0;
                totalWages += salVal + (salVal/2 * (parseFloat(row.querySelector('.d-ot').value) || 0)) + (parseFloat(row.querySelector('.d-pet').value) || 0) + (parseFloat(row.querySelector('.d-food').value) || 0);
            });
            document.getElementById('resTotal').innerText = "â‚¹" + Math.round(val).toLocaleString();
            document.getElementById('resExpDisplay').innerText = "â‚¹" + Math.round(totalWages).toLocaleString();
            return { val, totalWages };
        }

        async function saveData() {
            const isH = document.getElementById('isHoliday').checked;
            const cust = document.getElementById('customer').value.trim();
            if (!isH && !cust) { showMessage("CUSTOMER REQUIRED"); return; }
            const cal = calculate(), logs = [];
            
            if (!isH && document.getElementById('helperSectionToggle').checked) {
                document.querySelectorAll('.day-entry').forEach(row => { 
                    logs.push({ hDate: row.querySelector('.d-hdate').value, helper: row.querySelector('.d-helper').value, sal: row.querySelector('.d-sal').value, ot: row.querySelector('.d-ot').value, pet: row.querySelector('.d-pet').value, food: row.querySelector('.d-food').value }); 
                });
            }

            const data = { 
                date: document.getElementById('date').value, qn: document.getElementById('qn').value, customer: cust, location: document.getElementById('location').value, projectType: document.getElementById('projectType').value, company: document.getElementById('company').value, windowQty: document.getElementById('windowQty').value, totalSqft: document.getElementById('totalSqft').value, amtRate: document.getElementById('amtRate').value, total: cal.val, logs: logs, isHoliday: isH, comment: isH ? document.getElementById('holidayReason').value : document.getElementById('workNotes').value,
                paymentStatus: document.getElementById('paymentStatus').value
            };
            const id = document.getElementById('editId').value;
            if(id) await db.collection("workLogs").doc(id).update(data); else await db.collection("workLogs").add(data);
            location.reload();
        }

        async function deleteDoc(id) {
            if(confirm("Permanently delete this record?")) { await db.collection("workLogs").doc(id).delete(); showMessage("Deleted"); }
        }

        db.collection("workLogs").orderBy("date", "desc").onSnapshot(snap => { 
            allEntries = snap.docs.map(doc => ({ id: doc.id, ...doc.data() })); 
            applyFilters();
            generateTargetStatusReport();
        });

        function applyFilters() {
            const fM = document.getElementById('filterMonth').value, fY = document.getElementById('filterYear').value;
            let currentEarned = 0, soloEarn = 0, partnerEarn = 0, recordCount = 0;
            const tbody = document.getElementById('historyTableBody'); tbody.innerHTML = "";
            document.getElementById('historyMonthName').innerText = `${monthNames[fM]} ${fY}`;

            allEntries.forEach(d => {
                const eD = new Date(d.date);
                if((eD.getMonth() == fM) && (eD.getFullYear() == fY)) {
                    recordCount++;
                    let siteExp = 0, helpers = [];
                    d.logs?.forEach(l => { 
                        const sVal = parseFloat(l.sal) || 0;
                        siteExp += sVal + (sVal/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
                        if(!helpers.includes(l.helper)) helpers.push(l.helper); 
                    });
                    const net = (parseFloat(d.total)||0) - siteExp;
                    const myShare = d.projectType === 'Partner' ? (net/2) : net;
                    if(!d.isHoliday) { currentEarned += myShare; if(d.projectType === 'Partner') partnerEarn += (net/2); else soloEarn += net; }
                    
                    const pStatus = d.paymentStatus || 'Pending';
                    const statClass = pStatus === 'Received' ? 'status-received' : pStatus === 'Pending' ? 'status-pending' : 'status-unknown';

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${d.date.split('-').slice(1).join('/')}</td>
                        <td class="opacity-60">${d.qn || '-'}</td>
                        <td class="font-bold opacity-80">${d.company || '-'}</td>
                        <td class="font-bold">${d.isHoliday ? 'HOL' : d.customer}</td>
                        <td class="italic">${helpers.join(', ') || '-'}</td>
                        <td>${d.windowQty || '-'}</td>
                        <td class="text-[8px] font-black">${d.projectType[0]}</td>
                        <td>â‚¹${Math.round(d.total || 0).toLocaleString()}</td>
                        <td><span class="status-badge ${statClass}">${pStatus}</span></td>
                        <td class="font-bold">â‚¹${Math.round(myShare).toLocaleString()}</td>
                        <td class="space-x-2">
                            <button onclick="editDoc('${d.id}')" class="text-blue-500"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteDoc('${d.id}')" class="text-red-500"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    `;
                    tbody.appendChild(row);
                }
            });
            document.getElementById('recordCount').innerText = `${recordCount} records`;
            document.getElementById('tblSolo').innerText = "â‚¹" + Math.round(soloEarn).toLocaleString();
            document.getElementById('tblPartnerMine').innerText = "â‚¹" + Math.round(partnerEarn).toLocaleString();
            document.getElementById('tblGrandTotal').innerText = "â‚¹" + Math.round(soloEarn + partnerEarn).toLocaleString();
            updateTargetUI(currentEarned, fM);
        }

        function generatePerformanceInsights() {
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            const target = parseFloat(globalSettings.target) || 50000;
            
            document.getElementById('insightSelectedLabel').innerText = `${monthNames[fM]} ${fY} Performance Analysis`;
            
            let totalProfit = 0, totalSqft = 0, billTotal = 0, sitesCount = 0;
            let companyStats = {};
            
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && !d.isHoliday) {
                    sitesCount++;
                    let siteExp = 0;
                    d.logs?.forEach(l => { 
                        const sVal = parseFloat(l.sal) || 0;
                        siteExp += sVal + (sVal/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
                    });
                    const net = (parseFloat(d.total)||0) - siteExp;
                    const myProfit = d.projectType === 'Partner' ? (net/2) : net;
                    
                    totalProfit += myProfit;
                    totalSqft += (parseFloat(d.totalSqft) || 0);
                    billTotal += (parseFloat(d.total) || 0);
                    
                    const co = d.company || "Other";
                    companyStats[co] = (companyStats[co] || 0) + myProfit;
                }
            });

            // Populate Grid
            const grid = document.getElementById('monthlyBreakdownGrid');
            grid.innerHTML = `
                <div class="bg-blue-600/10 p-3 rounded-2xl border border-blue-500/20">
                    <div class="text-[9px] font-black opacity-50 uppercase">Total Profit</div>
                    <div class="text-xl font-black text-blue-500">â‚¹${Math.round(totalProfit).toLocaleString()}</div>
                </div>
                <div class="bg-green-600/10 p-3 rounded-2xl border border-green-500/20">
                    <div class="text-[9px] font-black opacity-50 uppercase">Total Area</div>
                    <div class="text-xl font-black text-green-500">${totalSqft} <span class="text-[10px]">Sqft</span></div>
                </div>
                <div class="bg-yellow-600/10 p-3 rounded-2xl border border-yellow-500/20">
                    <div class="text-[9px] font-black opacity-50 uppercase">Gross Billing</div>
                    <div class="text-xl font-black text-yellow-500">â‚¹${Math.round(billTotal).toLocaleString()}</div>
                </div>
                <div class="bg-purple-600/10 p-3 rounded-2xl border border-purple-500/20">
                    <div class="text-[9px] font-black opacity-50 uppercase">Active Sites</div>
                    <div class="text-xl font-black text-purple-500">${sitesCount}</div>
                </div>
            `;

            // Populate Details
            const details = document.getElementById('monthlyPerformanceDetails');
            let coHtml = '<div class="space-y-4"><div><label class="text-blue-400 mb-2">Profit by Company</label>';
            
            const sortedCos = Object.entries(companyStats).sort((a,b) => b[1] - a[1]);
            
            if(sortedCos.length === 0) {
                coHtml += '<div class="text-xs italic opacity-50">No site data for this month.</div>';
            } else {
                sortedCos.forEach(([co, profit]) => {
                    const coPercent = Math.min((profit / totalProfit) * 100, 100) || 0;
                    coHtml += `
                        <div class="mb-3">
                            <div class="flex justify-between text-[11px] font-bold mb-1">
                                <span>${co}</span>
                                <span>â‚¹${Math.round(profit).toLocaleString()}</span>
                            </div>
                            <div class="w-full bg-white/5 h-1.5 rounded-full">
                                <div class="bg-blue-500 h-full rounded-full transition-all duration-1000" style="width: ${coPercent}%"></div>
                            </div>
                        </div>
                    `;
                });
            }
            coHtml += '</div>';

            // Target Achievement
            const targetAch = (totalProfit / target) * 100;
            coHtml += `
                <div class="bg-black/20 p-4 rounded-2xl border border-white/5">
                    <div class="flex justify-between items-center mb-2">
                        <label class="m-0 text-white">Target Completion</label>
                        <span class="text-xs font-black ${targetAch >= 100 ? 'text-green-500' : 'text-yellow-500'}">${Math.round(targetAch)}%</span>
                    </div>
                    <div class="w-full bg-white/10 h-2 rounded-full mb-3">
                        <div class="bg-gradient-to-r from-blue-600 to-indigo-500 h-full rounded-full" style="width: ${Math.min(targetAch, 100)}%"></div>
                    </div>
                    <p class="text-[10px] opacity-60 leading-relaxed italic">
                        ${targetAch >= 100 ? "Excellent work! You've surpassed your monthly goal." : 
                          targetAch >= 70 ? "Good progress. You're close to meeting your target." : 
                          "Keep pushing. You're currently below the desired target for this month."}
                    </p>
                </div>
            `;

            details.innerHTML = coHtml;
        }

        function shareWhatsApp() {
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            const monthLabel = monthNames[fM];
            let msg = `*ðŸ“Š Work Statement: ${monthLabel} ${fY}*\n\n`;
            const solo = document.getElementById('tblSolo').innerText;
            const partner = document.getElementById('tblPartnerMine').innerText;
            const grand = document.getElementById('tblGrandTotal').innerText;
            msg += `*ðŸ’° OVERALL SUMMARY*\nSolo Earnings: ${solo}\nPartner Share: ${partner}\n*TOTAL NET EARNED: ${grand}*\n\n`;

            let helperData = {};
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && d.logs?.length > 0) {
                    d.logs.forEach(l => {
                        const sVal = parseFloat(l.sal) || 0;
                        const total = sVal + (sVal/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
                        helperData[l.helper] = (helperData[l.helper] || 0) + total;
                    });
                }
            });
            
            if(Object.keys(helperData).length > 0) {
                msg += `*ðŸ‘· HELPER PAYMENTS*\n`;
                for(let h in helperData) msg += `${h}: â‚¹${Math.round(helperData[h]).toLocaleString()}\n`;
                msg += `\n`;
            }

            let received = 0, pending = 0;
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && !d.isHoliday) {
                    if(d.paymentStatus === 'Received') received += (parseFloat(d.total) || 0);
                    else pending += (parseFloat(d.total) || 0);
                }
            });
            msg += `*ðŸ’³ PAYMENT TRACKER*\nTotal Received: â‚¹${Math.round(received).toLocaleString()}\nTotal Pending: â‚¹${Math.round(pending).toLocaleString()}\n\n_Generated via Ayyappan Pro Manager_`;
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function exportHelperPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l'); 
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            doc.text(`Helper Payment Details: ${monthNames[fM]} ${fY}`, 14, 15);
            const tableRows = [];
            allEntries.forEach(entry => {
                const ed = new Date(entry.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && entry.logs?.length > 0) {
                    entry.logs.forEach(log => {
                        const baseSal = parseFloat(log.sal) || 0;
                        const otAmt = (baseSal / 2) * (parseFloat(log.ot) || 0);
                        const totalRow = baseSal + otAmt + (parseFloat(log.pet) || 0) + (parseFloat(log.food) || 0);
                        tableRows.push([log.hDate || entry.date, log.helper, entry.customer || 'Site', `Rs. ${baseSal}`, log.ot || 0, `Rs. ${Math.round(totalRow)}`]);
                    });
                }
            });
            doc.autoTable({ startY: 28, head: [['Date', 'Helper', 'Site', 'Salary', 'OT', 'Total']], body: tableRows });
            doc.save(`Helpers_${monthNames[fM]}_${fY}.pdf`);
        }

        function exportPartnerPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l'); 
            const fM = document.getElementById('filterMonth').value;
            const fY = document.getElementById('filterYear').value;
            doc.text(`Business Summary: ${monthNames[fM]} ${fY}`, 14, 15);
            const tableRows = [];
            allEntries.forEach(d => {
                const ed = new Date(d.date);
                if(ed.getMonth() == fM && ed.getFullYear() == fY && !d.isHoliday) {
                    let totalExp = 0;
                    d.logs?.forEach(l => {
                        const s = parseFloat(l.sal) || 0;
                        totalExp += s + (s/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0);
                    });
                    const share = (d.projectType === 'Partner' ? (d.total-totalExp)/2 : (d.total-totalExp));
                    tableRows.push([d.date, d.company || '-', d.customer, `Rs. ${Math.round(d.total)}`, `Rs. ${Math.round(totalExp)}`, d.projectType, `Rs. ${Math.round(share)}`]);
                }
            });
            doc.autoTable({ startY: 28, head: [['Date', 'Company', 'Customer', 'Bill', 'Wages', 'Type', 'Profit']], body: tableRows });
            doc.save(`Partner_${monthNames[fM]}_${fY}.pdf`);
        }

        function updateTargetUI(earned, monthFilter) {
            let target = parseFloat(globalSettings.target) || 50000;
            const percent = Math.min((earned / target) * 100, 100);
            document.getElementById('targetBar').style.width = percent + "%";
            document.getElementById('targetEarned').innerText = `Earned: â‚¹${Math.round(earned).toLocaleString()}`;
            document.getElementById('targetGoal').innerText = `Target: â‚¹${target.toLocaleString()}`;
            document.getElementById('targetRem').innerText = `â‚¹${Math.max(0, Math.round(target - earned)).toLocaleString()}`;
        }

        function generateTargetStatusReport() {
            const container = document.getElementById('annualTargetReportList');
            const year = document.getElementById('reportYearSelect').value;
            const targetPerMonth = parseFloat(globalSettings.target) || 50000;
            container.innerHTML = "";
            let annualTotal = 0, monthsMet = 0, monthsTracked = 0;
            monthNames.forEach((name, idx) => {
                let monthlyProfit = 0, hasData = false;
                allEntries.forEach(d => {
                    const dD = new Date(d.date);
                    if(dD.getFullYear() == year && dD.getMonth() == idx && !d.isHoliday) {
                        hasData = true;
                        let exp = 0; d.logs?.forEach(l => { const s = parseFloat(l.sal)||0; exp += s + (s/2 * (parseFloat(l.ot)||0)) + (parseFloat(l.pet)||0) + (parseFloat(l.food)||0); });
                        const net = (parseFloat(d.total)||0) - exp;
                        monthlyProfit += (d.projectType === 'Partner' ? net/2 : net);
                    }
                });
                if(hasData) {
                    monthsTracked++; if(monthlyProfit >= targetPerMonth) monthsMet++; annualTotal += monthlyProfit;
                    container.innerHTML += `<div class="bg-white/5 p-3 rounded-xl border border-white/5 flex justify-between"><span>${name}</span><span>â‚¹${Math.round(monthlyProfit).toLocaleString()}</span></div>`;
                }
            });
            document.getElementById('annualTotalVal').innerText = `â‚¹${Math.round(annualTotal).toLocaleString()}`;
            document.getElementById('annualSuccessRate').innerText = `${monthsTracked > 0 ? Math.round((monthsMet / monthsTracked) * 100) : 0}%`;
        }

        function editDoc(id) {
            const d = allEntries.find(e => e.id === id);
            document.getElementById('editId').value = id; 
            document.getElementById('date').value = d.date; 
            document.getElementById('customer').value = d.customer; 
            document.getElementById('qn').value = d.qn || "";
            document.getElementById('location').value = d.location || "";
            document.getElementById('windowQty').value = d.windowQty || "";
            document.getElementById('totalSqft').value = d.totalSqft || ""; 
            document.getElementById('amtRate').value = d.amtRate || "";
            document.getElementById('projectType').value = d.projectType; 
            document.getElementById('isHoliday').checked = d.isHoliday;
            setPaymentStatus(d.paymentStatus || 'Pending');
            const logs = d.logs || [];
            document.getElementById('dayLogsContainer').innerHTML = ""; 
            if(logs.length > 0) { document.getElementById('helperSectionToggle').checked = true; toggleHelperVisibility(); logs.forEach(l => addDayRow(l)); }
            else { document.getElementById('helperSectionToggle').checked = false; toggleHelperVisibility(); }
            checkHoliday(); calculate(); window.scrollTo({top: 0, behavior: 'smooth'});
        }

        function toggleSettings() { const m = document.getElementById('settingsModal'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; }
        
        function toggleReport() { 
            const m = document.getElementById('smartReportModal'); 
            const isClosing = m.style.display === 'flex';
            if(!isClosing) {
                generatePerformanceInsights();
                m.style.display = 'flex';
            } else {
                m.style.display = 'none';
            }
        }
        
        function checkHoliday() { 
            const isH = document.getElementById('isHoliday').checked;
            document.getElementById('workFields').style.display = isH ? 'none' : 'block'; 
            document.getElementById('holidayReasonDiv').classList.toggle('hidden', !isH); 
            if (isH) {
                document.getElementById('helperSectionToggle').checked = false;
                document.getElementById('dayLogsContainer').classList.add('hidden');
                document.getElementById('addHelperBtn').classList.add('hidden');
                document.getElementById('helperGlobalWrapper').style.display = 'none';
                document.getElementById('dayLogsContainer').innerHTML = ""; 
            } else {
                document.getElementById('helperGlobalWrapper').style.display = 'block';
            }
        }

        async function backupData() {
            const blob = new Blob([JSON.stringify(allEntries)], {type: "application/json"});
            const url = URL.createObjectURL(blob); const a = document.createElement("a"); a.href = url; a.download = `Backup.json`; a.click();
        }

        async function restoreData(event) {
            const file = event.target.files[0]; if(!file) return;
            const reader = new FileReader(); reader.onload = async (e) => {
                const data = JSON.parse(e.target.result);
                if(confirm(`Import ${data.length} records?`)) { for(const item of data) { delete item.id; await db.collection("workLogs").add(item); } location.reload(); }
            };
            reader.readAsText(file);
        }

        window.onload = async () => { 
            const now = new Date(); initTheme();
            document.getElementById('date').valueAsDate = now; 
            setPaymentStatus('Pending');
            await syncSettings(); 
            document.getElementById('filterMonth').value = now.getMonth();
            document.getElementById('filterYear').value = now.getFullYear();
            applyFilters();
            fetchDailyKural();
        };
    </script>
</body>
</html>
